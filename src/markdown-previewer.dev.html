<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="manifest" href="./manifest.webmanifest" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("./sw.js", { scope: "./" })
          .catch(console.error);
      }
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown Previewer</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24' viewBox='0 0 24 24' id='markdown'><path fill='%236766DB' d='M17.149,16.155l-3.317-3.828c-0.281-0.324-0.049-0.827,0.378-0.827h1.712V8.28c0-0.276,0.224-0.5,0.5-0.5h2.212c0.276,0,0.5,0.224,0.5,0.5v3.22h1.711c0.427,0,0.658,0.504,0.378,0.827l-3.317,3.828C17.707,16.386,17.347,16.386,17.149,16.155z'></path><path class='favicon-dark-contrast' fill='%23110638' d='M21.842,19.5H2.158C0.968,19.5,0,18.54,0,17.359V6.641C0,5.46,0.968,4.5,2.158,4.5h19.684C23.032,4.5,24,5.46,24,6.641v10.719C24,18.54,23.032,19.5,21.842,19.5z M2.158,5.5C1.52,5.5,1,6.012,1,6.641v10.719C1,17.988,1.52,18.5,2.158,18.5h19.684C22.48,18.5,23,17.988,23,17.359V6.641C23,6.012,22.48,5.5,21.842,5.5H2.158z'></path><path class='favicon-dark-contrast' fill='%23110638' d='M12.664,16.219h-2.212c-0.276,0-0.5-0.224-0.5-0.5v-2.853l-1.323,1.636c-0.189,0.234-0.588,0.234-0.777,0l-1.323-1.636v2.853c0,0.276-0.224,0.5-0.5,0.5H3.816c-0.276,0-0.5-0.224-0.5-0.5V8.28c0-0.276,0.224-0.5,0.5-0.5h2.212c0.151,0,0.294,0.068,0.389,0.186l1.823,2.255l1.823-2.255c0.095-0.117,0.237-0.186,0.389-0.186h2.212c0.276,0,0.5,0.224,0.5,0.5v7.438C13.164,15.995,12.94,16.219,12.664,16.219z M10.952,15.219h1.212V8.78H10.69l-2.062,2.55c-0.189,0.234-0.588,0.234-0.777,0L5.79,8.78H4.316v6.438h1.212v-3.766c0-0.212,0.134-0.4,0.333-0.472c0.199-0.069,0.423-0.008,0.556,0.157l1.823,2.254l1.823-2.254c0.133-0.164,0.356-0.225,0.556-0.157c0.199,0.071,0.333,0.26,0.333,0.472V15.219z'></path></svg>"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24' viewBox='0 0 24 24' id='markdown'><path fill='%236766DB' d='M17.149,16.155l-3.317-3.828c-0.281-0.324-0.049-0.827,0.378-0.827h1.712V8.28c0-0.276,0.224-0.5,0.5-0.5h2.212c0.276,0,0.5,0.224,0.5,0.5v3.22h1.711c0.427,0,0.658,0.504,0.378,0.827l-3.317,3.828C17.707,16.386,17.347,16.386,17.149,16.155z'></path><path class='favicon-light-contrast' fill='%23fff' d='M21.842,19.5H2.158C0.968,19.5,0,18.54,0,17.359V6.641C0,5.46,0.968,4.5,2.158,4.5h19.684C23.032,4.5,24,5.46,24,6.641v10.719C24,18.54,23.032,19.5,21.842,19.5z M2.158,5.5C1.52,5.5,1,6.012,1,6.641v10.719C1,17.988,1.52,18.5,2.158,18.5h19.684C22.48,18.5,23,17.988,23,17.359V6.641C23,6.012,22.48,5.5,21.842,5.5H2.158z'></path><path class='favicon-light-contrast' fill='%23fff' d='M12.664,16.219h-2.212c-0.276,0-0.5-0.224-0.5-0.5v-2.853l-1.323,1.636c-0.189,0.234-0.588,0.234-0.777,0l-1.323-1.636v2.853c0,0.276-0.224,0.5-0.5,0.5H3.816c-0.276,0-0.5-0.224-0.5-0.5V8.28c0-0.276,0.224-0.5,0.5-0.5h2.212c0.151,0,0.294,0.068,0.389,0.186l1.823,2.255l1.823-2.255c0.095-0.117,0.237-0.186,0.389-0.186h2.212c0.276,0,0.5,0.224,0.5,0.5v7.438C13.164,15.995,12.94,16.219,12.664,16.219z M10.952,15.219h1.212V8.78H10.69l-2.062,2.55c-0.189,0.234-0.588,0.234-0.777,0L5.79,8.78H4.316v6.438h1.212v-3.766c0-0.212,0.134-0.4,0.333-0.472c0.199-0.069,0.423-0.008,0.556,0.157l1.823,2.254l1.823-2.254c0.133-0.164,0.356-0.225,0.556-0.157c0.199,0.071,0.333,0.26,0.333,0.472V15.219z'></path></svg>"
      media="(prefers-color-scheme: dark)"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/16.3.0/lib/marked.umd.min.js"
      integrity="sha512-V6rGY7jjOEUc7q5Ews8mMlretz1Vn2wLdMW/qgABLWunzsLfluM0FwHuGjGQ1lc8jO5vGpGIGFE+rTzB+63HdA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.0/highlight.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"
      integrity="sha512-qtX0GLM3qX8rxJN1gyDfcnMFFrKvixfoEOwbBib9VafR5vbChV5LeE5wSI/x+IlCkTY5ZFddFDCCfaVJJNnuKQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      id="highlight-light"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.0/styles/github.min.css"
    />
    <link
      rel="stylesheet"
      id="highlight-dark"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.0/styles/github-dark.min.css"
      disabled
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ========================================
         CSS CUSTOM PROPERTIES (VARIABLES)
         ======================================== */
      :root {
        /* Colors - Light Theme */
        --color-primary: #5b7fd9;
        --color-primary-dark: #4a6bc3;
        --color-primary-light: #5a7fd7;
        --color-secondary: #6b3f99;
        --color-text: #333;
        --color-text-light: #666;
        --color-text-lighter: #999;
        --color-text-muted: #6a737d;
        --color-bg: #f5f5f5;
        --color-bg-white: #fff;
        --color-bg-light: #fafafa;
        --color-bg-panel: #f9f9f9;
        --color-bg-hover: #f0f0f0;
        --color-bg-code: #f6f8fa;
        --color-border: #ddd;
        --color-border-light: #e0e0e0;
        --color-border-lighter: #e8e8e8;
        --color-border-table: #dfe2e5;
        --color-heading: #2c3e50;
        --color-link: #0e5dc8;
        --color-danger: #e74c3c;
        --color-danger-bg: #ffebee;

        /* Colors - Overlays & Shadows */
        --color-overlay-10: rgba(0, 0, 0, 0.1);
        --color-overlay-15: rgba(255, 255, 255, 0.15);
        --color-overlay-25: rgba(255, 255, 255, 0.25);

        /* Button backgrounds */
        --color-btn-bg: rgba(0, 0, 0, 0.04);
        --color-btn-bg-hover: rgba(0, 0, 0, 0.15);

        /* Colors - Dark Theme */
        --color-dark-bg: #1e1e1e;
        --color-dark-bg-panel: #252526;
        --color-dark-bg-secondary: #2d2d2d;
        --color-dark-bg-tertiary: #262626;
        --color-dark-bg-code: #1a1a1a;
        --color-dark-bg-hover: #252530;
        --color-dark-bg-active: linear-gradient(135deg, #1a2332, #1e2840);
        --color-dark-bg-card: #1e1e1e;
        --color-dark-bg-preview: #1a1a1a;
        --color-dark-bg-warning: #3a3520;
        --color-dark-bg-danger: #3a1a1a;

        --color-dark-text: #eee;
        --color-dark-text-light: #aaa;
        --color-dark-text-lighter: #777;
        --color-dark-text-muted: #666;
        --color-dark-text-preview: #ccc;
        --color-dark-heading: #e0e0e0;
        --color-dark-code: #e6e6e6;
        --color-dark-code-block: #d4d4d4;
        --color-dark-link: #57a0f8;
        --color-dark-warning: #ffc107;
        --color-dark-warning-text: #ffd54f;

        --color-dark-border: #444;
        --color-dark-border-light: #555;
        --color-dark-border-lighter: #777;

        --color-dark-scrollbar-track: #333;
        --color-dark-scrollbar-thumb: #666;
        --color-dark-scrollbar-thumb-hover: #888;

        /* Dark theme button backgrounds */
        --color-dark-btn-bg: rgba(255, 255, 255, 0.04);
        --color-dark-btn-bg-hover: rgba(255, 255, 255, 0.14);

        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 12px;
        --spacing-lg: 15px;
        --spacing-xl: 20px;

        /* Border Radius */
        --radius-sm: 3px;
        --radius-md: 6px;
        --radius-lg: 9px;

        /* Transitions */
        --transition-fast: 0.2s ease;
        --transition-normal: 0.35s ease;
        --transition-theme: 0.5s cubic-bezier(0.4, 0, 0.2, 1);

        /* Shadows */
        --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
        --shadow-primary: 0 4px 12px rgba(91, 127, 217, 0.15);
        --shadow-primary-lg: 0 8px 25px rgba(91, 127, 217, 0.15);

        /* Font Families */
        --font-system: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Consolas,
          "Liberation Mono", monospace;
        --font-rtl: "Vazirmatn", sans-serif;

        /* Z-index */
        --z-resizer: 10;
      }

      /* ========================================
         GLOBAL RESET & BASE STYLES
         ======================================== */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-system);
        line-height: 1.6;
        color: var(--color-text);
        background-color: var(--color-bg);
        direction: ltr;
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      /* ========================================
         LAYOUT
         ======================================== */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 10px;
      }

      header {
        text-align: center;
        margin-bottom: var(--spacing-md);
        padding: 10px;
        background: linear-gradient(
          135deg,
          var(--color-primary-light),
          var(--color-secondary)
        );
        color: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        transition: background var(--transition-theme);
      }

      .header-title {
        font-size: 13.5px;
      }

      /* ========================================
         HEADER CONTROLS
         ======================================== */
      .header-controls {
        position: absolute;
        right: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .header-doc-info {
        display: flex;
        align-items: center;
        background-color: var(--color-overlay-15);
        border: 1px solid var(--color-overlay-15);
        border-radius: var(--radius-md);
        overflow: hidden;
        height: 32px;
        gap: 1px;
      }

      /* Document badge button */
      .doc-badge-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-overlay-10);
        color: white;
        height: 100%;
      }

      .doc-badge-btn:hover,
      .doc-badge-btn.active {
        background-color: var(--color-overlay-15);
      }

      /* Autosave and manual save buttons */
      .autosave-toggle-btn,
      .manual-save-btn-split {
        padding: var(--spacing-sm);
        background-color: var(--color-btn-bg);
        color: var(--color-text);
      }

      .autosave-toggle-btn:hover,
      .manual-save-btn-split:hover {
        background-color: var(--color-btn-bg-hover);
      }

      .autosave-toggle-btn.off {
        opacity: 0.6;
      }

      .autosave-toggle-btn.off:hover {
        opacity: 0.8;
      }

      /* Manual save button visibility states */
      .manual-save-btn-split {
        opacity: 0;
        transform: scale(0.7) translateX(25px);
        pointer-events: none;
        max-width: 0;
        padding-left: 0;
        padding-right: 0;
        overflow: hidden;
        transition: all var(--transition-normal);
      }

      .manual-save-btn-split.visible {
        opacity: 1;
        transform: scale(1) translateX(0);
        pointer-events: auto;
        max-width: 40px; /* Approximate width of the button */
        padding: var(--spacing-sm);
      }

      /* ========================================
         ANIMATIONS
         ======================================== */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes iconExit {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(24px) rotate(180deg);
          opacity: 0;
        }
      }

      @keyframes iconEnter {
        0% {
          transform: translateY(-24px) rotate(-180deg);
          opacity: 0;
        }
        100% {
          transform: translateY(0) rotate(0deg);
          opacity: 1;
        }
      }

      /* ========================================
         THEME TOGGLE BUTTON
         ======================================== */
      #btn-theme-toggle {
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-overlay-15);
        color: white;
        border: 1px solid var(--color-overlay-15);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        transition: all var(--transition-normal);
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      #btn-theme-toggle:hover {
        background-color: var(--color-overlay-25);
        border-color: rgba(255, 255, 255, 0.3);
      }

      #btn-theme-toggle .icon-svg {
        transition: transform var(--transition-theme),
          opacity var(--transition-theme);
      }

      #btn-theme-toggle .icon-svg.exiting {
        animation: iconExit var(--transition-theme) forwards;
      }
      #btn-theme-toggle .icon-svg.entering {
        animation: iconEnter var(--transition-theme) forwards;
      }

      /* ========================================
         TYPOGRAPHY
         ======================================== */
      h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
      }

      /* ========================================
         BUTTONS - BASE STYLES
         ======================================== */
      button {
        padding: 5px var(--spacing-sm);
        margin: 2px 0;
        background-color: var(--color-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color var(--transition-normal);
      }

      button:hover {
        background-color: var(--color-primary-dark);
      }

      /* ========================================
         EDITOR CONTAINER & PANELS
         ======================================== */
      .editor-container {
        display: flex;
        gap: var(--spacing-sm);
        height: auto;
        min-height: 50vh;
        position: relative;
      }

      .panel {
        border-radius: var(--radius-lg);
        overflow: hidden;
        background-color: var(--color-bg-white);
        box-shadow: var(--shadow-sm);
        flex: 1;
        min-width: 10%;
        position: relative;
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      .resizer {
        width: var(--spacing-sm);
        cursor: col-resize;
        background-color: var(--color-border-lighter);
        position: relative;
        z-index: var(--z-resizer);
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      .resizer:hover,
      .resizer.active {
        background-color: var(--color-primary);
      }

      .panel-header {
        padding: 5px var(--spacing-md);
        background-color: var(--color-bg-white);
        font-weight: bold;
        border-bottom: 1px solid var(--color-border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color var(--transition-theme),
          border-bottom-color var(--transition-theme);
      }

      .panel-controls {
        display: flex;
        gap: 10px;
      }

      .panel-content {
        height: calc(100% - 40px);
      }

      #markdown-editor {
        width: 100%;
        height: 100%;
        border: none;
        padding: var(--spacing-md);
        font-family: var(--font-mono);
        font-size: 1rem;
        resize: none;
        direction: rtl;
        unicode-bidi: plaintext;
        background-color: var(--color-bg-code);
        color: var(--color-text);
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      #markdown-editor::placeholder {
        direction: ltr;
        unicode-bidi: plaintext;
        font-style: italic;
      }

      /* ========================================
         PREVIEW PANEL STYLES
         ======================================== */
      #preview {
        height: 100%;
        padding: var(--spacing-md) var(--spacing-lg);
        overflow-y: auto;
        line-height: 1.7;
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      #preview .rtl-text {
        font-family: var(--font-rtl);
        direction: rtl;
        text-align: justify;
      }

      #preview h1,
      #preview h2,
      #preview h3,
      #preview h4,
      #preview h5,
      #preview h6 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: var(--color-heading);
        font-weight: 600;
        transition: color var(--transition-theme),
          border-bottom-color var(--transition-theme);
      }

      #preview h1 {
        font-size: 2rem;
        border-bottom: 2px solid #eaecef;
        padding-bottom: 0.3rem;
      }

      #preview h2 {
        font-size: 1.5rem;
        border-bottom: 1px solid #eaecef;
        padding-bottom: 0.3rem;
      }

      #preview p {
        margin-bottom: 1rem;
        text-align: justify;
      }

      #preview blockquote {
        border-left: 4px solid var(--color-primary);
        padding-left: 1rem;
        margin-left: 0;
        color: var(--color-text-muted);
        direction: ltr;
        text-align: left;
      }

      #preview blockquote.rtl-text {
        border-left: none;
        border-right: 4px solid var(--color-primary);
        padding-left: 0;
        padding-right: 1rem;
        margin-left: 0;
        margin-right: 0;
        direction: rtl;
        text-align: right;
      }

      #preview ul,
      #preview ol {
        padding-left: 2rem;
        margin-bottom: 1rem;
        text-align: justify;
        list-style-position: outside;
      }

      /* For fully RTL lists */
      #preview ul.rtl-text,
      #preview ol.rtl-text {
        padding-left: 0;
        padding-right: 2rem;
        direction: rtl;
      }

      /* For individual RTL items in any list */
      #preview li.rtl-text {
        direction: rtl;
        text-align: justify;
      }

      /* For mixed lists - reset padding and use margin for bullet positioning */
      #preview ul:not(.rtl-text),
      #preview ol:not(.rtl-text) {
        padding-left: 0;
        padding-right: 0;
      }

      #preview ul:not(.rtl-text) li,
      #preview ol:not(.rtl-text) li {
        margin-left: 2rem;
        direction: ltr;
        text-align: left;
      }

      #preview ul:not(.rtl-text) li.rtl-text,
      #preview ol:not(.rtl-text) li.rtl-text {
        margin-left: 0;
        margin-right: 2rem;
        direction: rtl;
        text-align: justify;
      }

      #preview code {
        background-color: var(--color-bg-hover);
        padding: 0.2rem 0.4rem;
        border-radius: var(--radius-sm);
        font-family: var(--font-mono);
        font-size: 0.9em;
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      #preview pre {
        background-color: var(--color-bg-code);
        border-radius: 6px;
        padding: 16px;
        overflow: auto;
        margin-bottom: 1rem;
        transition: background-color var(--transition-theme);
      }

      #preview pre code {
        background-color: transparent;
        padding: 0;
        font-size: 0.9rem;
        white-space: pre;
      }

      #preview table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1rem;
      }

      #preview th,
      #preview td {
        border: 1px solid var(--color-border-table);
        padding: var(--spacing-sm) var(--spacing-md);
      }

      #preview th {
        background-color: var(--color-bg-code);
      }

      #preview th.rtl-text,
      #preview td.rtl-text {
        direction: rtl;
        text-align: right;
        font-family: var(--font-rtl);
      }

      #preview img {
        max-width: 100%;
        height: auto;
        margin: 10px 0;
        border-radius: var(--spacing-xs);
      }

      #preview a {
        color: var(--color-link);
        text-decoration: none;
        transition: color var(--transition-theme);
      }

      #preview a:hover {
        text-decoration: underline;
      }

      #preview hr {
        height: 1px;
        background-color: #e1e4e8;
        border: none;
        margin: 1.5rem 0;
      }

      /* ========================================
         STATUS BAR
         ======================================== */
      .status-bar {
        padding: var(--spacing-sm) var(--spacing-md);
        background-color: var(--color-bg-white);
        font-size: 0.71rem;
        color: var(--color-text-light);
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: var(--spacing-lg);
        border-radius: var(--spacing-xs);
        transition: background-color var(--transition-theme),
          color var(--transition-theme),
          border-top-color var(--transition-theme);
      }

      .status-center {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
      }

      .github-link {
        color: var(--color-text-light);
        text-decoration: none;
        opacity: 0.7;
        transition: opacity var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .github-link:hover {
        opacity: 1;
      }

      .github-link .icon-svg {
        width: 16px;
        height: 16px;
      }

      @media (max-width: 768px) {
        header {
          justify-content: flex-start; /* Override flex centering to align left */
        }

        .header-title {
          font-size: 11.5px !important;
        }

        .editor-container {
          flex-direction: column;
          height: auto;
          min-height: 30vh;
        }

        .panel {
          height: 30vh !important;
          min-height: 300px;
        }

        .panel-content {
          height: calc(100% - 40px);
        }

        .resizer {
          display: none;
        }

        #markdown-editor {
          min-height: calc(70vh - 110px);
        }

        #preview {
          padding: var(--spacing-md) var(--spacing-md);
          min-height: calc(70vh - 110px);
        }
      }

      /* Themes */
      .theme-dark {
        background-color: var(--color-dark-bg);
        color: var(--color-dark-text);
      }

      .theme-dark .panel,
      .theme-dark .toolbar,
      .theme-dark #markdown-editor,
      .theme-dark #preview,
      .theme-dark .doc-label {
        color: var(--color-dark-text);
      }

      .theme-dark .panel,
      .theme-dark .toolbar,
      .theme-dark #preview,
      .theme-dark .documents-bar,
      .theme-dark .modal-content {
        background-color: var(--color-dark-bg-panel);
      }

      .theme-dark .panel-header,
      .theme-dark .status-bar,
      .theme-dark .resizer,
      .theme-dark .autosave-status.off,
      .theme-dark .doc-action-btn:hover {
        background-color: var(--color-dark-bg-tertiary);
      }

      .theme-dark .panel-header,
      .theme-dark .modal-header {
        border-bottom-color: var(--color-dark-border);
      }

      .theme-dark #preview code,
      .theme-dark #preview th,
      .theme-dark #markdown-editor {
        background-color: var(--color-dark-bg-code);
        color: var(--color-dark-text);
      }

      .theme-dark #preview h1,
      .theme-dark #preview h2,
      .theme-dark #preview h3,
      .theme-dark #preview h4,
      .theme-dark #preview h5,
      .theme-dark #preview h6 {
        color: var(--color-dark-heading);
        border-bottom-color: var(--color-dark-border);
      }

      .theme-dark #preview blockquote,
      .theme-dark .status-bar,
      .theme-dark .doc-action-btn {
        color: var(--color-dark-text-light);
      }

      .theme-dark .status-bar {
        border-top-color: var(--color-dark-border);
        border-bottom-color: var(--color-dark-border);
      }

      .theme-dark .github-link {
        color: var(--color-dark-text-light);
      }

      .theme-dark #preview code {
        color: var(--color-dark-code);
      }

      .theme-dark #preview pre {
        background-color: var(--color-dark-bg-code);
      }

      .theme-dark #preview pre code {
        color: var(--color-dark-code-block);
      }

      .theme-dark #preview th,
      .theme-dark #preview td,
      .theme-dark .doc-card,
      .theme-dark .doc-preview,
      .theme-dark .documents-toggle {
        border-color: var(--color-dark-border);
      }

      .theme-dark #preview a {
        color: var(--color-dark-link);
      }

      .theme-dark .resizer:hover,
      .theme-dark .resizer.active {
        background-color: var(--color-primary);
      }

      .theme-dark #markdown-editor,
      .theme-dark #preview {
        scrollbar-width: thin;
        scrollbar-color: var(--color-dark-scrollbar-thumb)
          var(--color-dark-scrollbar-track);
      }

      .theme-dark #markdown-editor::-webkit-scrollbar,
      .theme-dark #preview::-webkit-scrollbar {
        width: 8px;
      }

      .theme-dark #markdown-editor::-webkit-scrollbar-track,
      .theme-dark #preview::-webkit-scrollbar-track {
        background: var(--color-dark-scrollbar-track);
        border-radius: 4px;
      }

      .theme-dark #markdown-editor::-webkit-scrollbar-thumb,
      .theme-dark #preview::-webkit-scrollbar-thumb {
        background: var(--color-dark-scrollbar-thumb);
        border-radius: 4px;
      }

      .theme-dark #markdown-editor::-webkit-scrollbar-thumb:hover,
      .theme-dark #preview::-webkit-scrollbar-thumb:hover {
        background: var(--color-dark-scrollbar-thumb-hover);
      }

      /* ========================================
         DOCUMENTS BAR & CARDS
         ======================================== */
      .documents-bar {
        background-color: var(--color-bg-white);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        transition: all var(--transition-normal),
          background-color var(--transition-theme);
      }

      .add-doc-btn {
        background: transparent;
        border: 2px dashed rgba(102, 126, 234, 0.3);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        cursor: pointer;
        transition: all var(--transition-normal);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        min-height: 120px;
        color: var(--color-primary);
        font-weight: 600;
        position: relative;
        overflow: hidden;
      }

      .add-doc-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.05),
          rgba(118, 75, 162, 0.05)
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .add-doc-btn:hover {
        border-color: var(--color-primary);
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        transform: translateY(-2px);
        box-shadow: var(--shadow-primary-lg);
      }

      .add-doc-btn:hover::before {
        opacity: 1;
      }

      .add-doc-btn .plus-icon {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--color-primary);
        transition: transform var(--transition-normal);
      }

      .add-doc-btn:hover .plus-icon {
        transform: scale(1.1);
      }

      .add-doc-btn .add-text {
        font-size: 0.9rem;
        margin-top: var(--spacing-xs);
      }

      .documents-bar.collapsed {
        max-height: 0;
        margin-bottom: 0;
        opacity: 0;
        box-shadow: none;
      }

      .documents-panel {
        max-height: 450px;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--spacing-md);
      }

      .doc-card {
        background-color: var(--color-bg-light);
        border: 2px solid var(--color-border-light);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        cursor: pointer;
        transition: all var(--transition-fast),
          background-color var(--transition-theme),
          color var(--transition-theme);
      }

      .doc-card:hover {
        border-color: var(--color-primary);
        background-color: #f5f8ff;
        box-shadow: var(--shadow-primary);
      }

      .doc-card.active {
        background: linear-gradient(135deg, #f0f7ff, #f5f8ff);
        border-color: var(--color-primary);
        box-shadow: 0 4px 12px rgba(110, 142, 251, 0.2);
      }

      .doc-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .doc-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .doc-meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: flex-start;
      }

      .doc-meta-row {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        width: 100%;
      }

      .doc-autosave-badge {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--color-bg-white);
        flex-shrink: 0;
        transition: all var(--transition-fast),
          background-color var(--transition-theme),
          color var(--transition-theme);
      }

      .doc-autosave-badge.enabled {
        color: var(--color-text);
        background-color: rgba(255, 255, 255, 0.4);
      }

      .doc-autosave-badge.disabled {
        color: var(--color-text-muted);
        opacity: 0.6;
      }

      .doc-card.active .doc-icon {
        transform: scale(1.1);
      }

      .doc-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--color-text);
      }

      .doc-time {
        font-size: 0.7rem;
        color: var(--color-text-lighter);
      }

      .doc-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .doc-action-btn {
        background-color: transparent;
        border: 1px solid var(--color-border);
        padding: 5px var(--spacing-sm);
        border-radius: var(--spacing-xs);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all var(--transition-normal);
        color: var(--color-text-light);
      }

      .doc-action-btn:hover {
        background-color: var(--color-bg-hover);
      }

      .delete-btn:hover {
        background-color: var(--color-danger-bg) !important;
        border-color: var(--color-danger) !important;
        color: var(--color-danger) !important;
      }

      /* Panel action buttons */
      #btn-copy-markdown,
      #btn-save-markdown,
      #btn-export-pdf {
        background: var(--color-btn-bg);
        color: var(--color-text);
        border-radius: var(--radius-md);
        transition: all var(--transition-normal);
        padding: var(--spacing-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
      }

      #btn-copy-markdown:hover,
      #btn-save-markdown:hover,
      #btn-export-pdf:hover {
        background: var(--color-btn-bg-hover);
      }

      .doc-preview {
        background-color: var(--color-bg-code);
        border: 1px solid var(--color-border-lighter);
        border-radius: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        min-height: 51px;
        max-height: 51px;
        overflow: hidden;
        transition: background-color var(--transition-theme),
          color var(--transition-theme);
      }

      .doc-preview-text {
        font-size: 0.7rem;
        line-height: 1.2;
        color: var(--color-text-light);
        font-family: var(--font-mono);
        white-space: pre-wrap;
        word-break: break-word;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .doc-preview-text.empty {
        color: var(--color-text-lighter);
        font-style: italic;
        font-family: inherit;
      }

      .doc-action-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .doc-action-btn:disabled:hover {
        background-color: transparent !important;
        border-color: var(--color-border) !important;
        transform: none !important;
      }

      /* Dark theme styles for documents bar */
      .theme-dark .documents-toggle {
        background-color: var(--color-dark-bg-secondary);
      }

      .theme-dark .toggle-docs-btn {
        color: var(--color-dark-text);
      }

      .theme-dark .toggle-docs-btn:hover {
        background-color: rgba(110, 142, 251, 0.2);
      }

      .theme-dark .autosave-status {
        background-color: var(--color-dark-bg-warning);
        color: var(--color-dark-warning);
      }

      .theme-dark .autosave-status.off,
      .theme-dark .doc-action-btn:hover {
        background-color: var(--color-dark-bg-tertiary);
      }

      .theme-dark .autosave-status.off,
      .theme-dark .doc-time {
        color: var(--color-dark-text-lighter);
      }

      .theme-dark .doc-card {
        background-color: var(--color-dark-bg-card);
      }

      .theme-dark .doc-card:hover {
        background-color: var(--color-dark-bg-hover);
        border-color: var(--color-primary);
      }

      .theme-dark .doc-card.active {
        background: var(--color-dark-bg-active);
        border-color: var(--color-primary);
      }

      .theme-dark .doc-autosave-badge {
        background-color: var(--color-dark-bg-tertiary);
      }

      .theme-dark .doc-autosave-badge.enabled {
        color: var(--color-dark-text);
      }

      .theme-dark .doc-autosave-badge.disabled {
        color: var(--color-dark-text-muted);
      }

      .theme-dark .doc-action-btn {
        background-color: transparent;
        border-color: var(--color-dark-border-light);
      }

      .theme-dark .doc-action-btn:hover {
        border-color: var(--color-dark-border-lighter);
      }

      .theme-dark .delete-btn:hover {
        background-color: var(--color-dark-bg-danger) !important;
        border-color: var(--color-danger) !important;
      }

      .theme-dark #btn-copy-markdown,
      .theme-dark #btn-save-markdown,
      .theme-dark #btn-export-pdf,
      .theme-dark .autosave-toggle-btn,
      .theme-dark .manual-save-btn-split {
        background: var(--color-dark-btn-bg);
        color: var(--color-dark-text);
      }

      .theme-dark #btn-copy-markdown:hover,
      .theme-dark #btn-save-markdown:hover,
      .theme-dark #btn-export-pdf:hover,
      .theme-dark .autosave-toggle-btn:hover,
      .theme-dark .manual-save-btn-split:hover {
        background: var(--color-dark-btn-bg-hover);
      }

      .theme-dark .doc-preview {
        background-color: var(--color-dark-bg-preview);
      }

      .theme-dark .doc-preview-text {
        color: var(--color-dark-text-preview);
      }

      .theme-dark .doc-preview-text.empty {
        color: var(--color-dark-text-muted);
      }

      /* Dark theme for add document button */
      .theme-dark .add-doc-btn {
        background: transparent;
        border-color: rgba(102, 126, 234, 0.4);
      }

      .theme-dark .add-doc-btn::before {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
      }

      .theme-dark .add-doc-btn:hover {
        border-color: var(--color-primary);
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.15),
          rgba(118, 75, 162, 0.15)
        );
      }

      .theme-dark .add-doc-btn:hover::before {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.15),
          rgba(118, 75, 162, 0.15)
        );
      }

      .theme-dark .add-doc-btn .plus-icon,
      .theme-dark .add-doc-btn .add-text,
      .theme-dark .add-doc-btn {
        color: #c0c0ff;
      }

      /* SVG Icon Styles */
      .icon-svg {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        vertical-align: middle;
      }

      .icon-svg-large {
        width: 24px;
        height: 24px;
      }

      .icon-svg svg {
        width: 100%;
        height: 100%;
        fill: currentColor;
      }

      /* Mini Modal */
      .mini-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }

      .mini-modal-overlay.is-visible {
        display: flex;
      }

      .mini-modal {
        background: var(--color-bg-white);
        color: var(--color-text);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        width: 100%;
        max-width: 420px;
        padding: 14px var(--spacing-lg);
      }

      .mini-modal-body {
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 12px;
        white-space: pre-line;
      }

      .mini-modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      body.theme-dark .mini-modal {
        background: var(--color-dark-bg-panel);
        color: var(--color-dark-text);
      }

      /* Toasts */
      #toast-container {
        position: fixed;
        right: 20px;
        bottom: 26px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 3000;
      }

      .mini-toast {
        position: relative;
        background: var(--color-bg-white);
        color: var(--color-text);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        padding: 14px 18px;
        max-width: 360px;
        border: 2px solid var(--color-border-light);
      }

      .mini-toast .toast-progress {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 4px;
        background: rgba(0, 0, 0, 0.06);
      }

      .mini-toast .toast-progress-bar {
        height: 100%;
        width: 100%;
        background: rgba(91, 127, 217, 0.75);
        transition: width linear;
      }

      body.theme-dark .mini-toast {
        background: var(--color-dark-bg-panel);
        color: var(--color-dark-text);
        border-color: var(--color-dark-border);
      }

      body.theme-dark .mini-toast .toast-progress {
        background: rgba(255, 255, 255, 0.08);
      }

      body.theme-dark .mini-toast .toast-progress-bar {
        background: rgba(87, 160, 248, 0.75);
      }

      /* ========================================
         SHARED VIEW BANNER
         ======================================== */
      .shared-view-banner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 6px var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .shared-view-banner.hidden {
        display: none;
      }

      .shared-banner-content {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .shared-banner-icon {
        font-size: 1.1rem;
      }

      .shared-banner-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .shared-banner-title {
        font-weight: 600;
        font-size: 0.8rem;
      }

      .shared-banner-subtitle {
        font-size: 0.7rem;
        opacity: 0.9;
      }

      .shared-banner-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .btn-save-to-slot {
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-overlay-15);
        color: white;
        border: 1px solid var(--color-overlay-10);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all var(--transition-normal);
        white-space: nowrap;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      .btn-save-to-slot:hover {
        background-color: var(--color-overlay-25);
        border-color: rgba(255, 255, 255, 0.3);
      }

      /* Adjust container padding when banner is visible */
      body.has-shared-banner .container {
        padding-top: 68px;
      }

      /* ========================================
         SHARE BUTTON
         ======================================== */
      #btn-share {
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-overlay-15);
        color: white;
        border: 1px solid var(--color-overlay-15);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        transition: all var(--transition-normal);
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      #btn-share:hover {
        background-color: var(--color-overlay-25);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .share-action {
        position: relative;
        display: flex;
        align-items: center;
      }

      .share-tooltip {
        position: absolute;
        visibility: hidden;
        top: calc(100% + var(--spacing-sm));
        right: -56px;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        background: var(--color-bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        box-shadow: var(--shadow-md);
        z-index: 5000;
        transition: transform var(--transition-fast),
          opacity var(--transition-fast), visibility var(--transition-fast);
        transform: translateY(-3px);
        opacity: 0;
        max-width: min(430px, calc(100vw - 12px));
      }

      .share-tooltip.is-visible {
        visibility: visible;
        transform: translateY(0);
        opacity: 1;
      }

      .share-tooltip-row {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .share-tooltip::before {
        content: "";
        position: absolute;
        top: -7px;
        right: 66px;
        width: 10px;
        height: 10px;
        background: inherit;
        border-left: 1px solid var(--color-border-light);
        border-top: 1px solid var(--color-border-light);
        transform: rotate(45deg);
      }

      .share-tooltip-link {
        flex: 1;
        min-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.7rem;
        color: var(--color-text);
        direction: ltr;
        unicode-bidi: plaintext;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas,
          "Liberation Mono", monospace;
        font-weight: 200;
        letter-spacing: -0.034em;
        white-space: nowrap;
      }

      .share-tooltip-warning {
        background: linear-gradient(135deg, #fffbf0, #fff8e1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: var(--radius-md);
        padding: var(--spacing-xs) var(--spacing-xs);
        transition: all var(--transition-normal);
        animation: slideIn 0.3s ease;
        width: 100%;
        box-sizing: border-box;
      }

      .share-tooltip-warning-text {
        font-size: 0.7rem;
        color: #856404;
        line-height: 1.2;
        display: block;
      }

      .share-tooltip-actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .share-tooltip-btn {
        border: none;
        background: var(--color-overlay-15);
        color: var(--color-text);
        border-radius: var(--radius-md);
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background var(--transition-normal),
          transform var(--transition-normal);
      }

      .share-tooltip-btn:hover {
        background: var(--color-overlay-25);
        transform: translateY(-1px);
      }

      .share-tooltip-btn:focus-visible {
        outline: 2px solid var(--color-primary);
        outline-offset: 2px;
      }

      .share-tooltip-btn .icon-svg {
        color: inherit;
      }

      .share-tooltip-btn .icon-svg svg {
        width: 16px;
        height: 16px;
      }

      .is-hidden {
        display: none !important;
      }

      body.theme-dark .share-tooltip {
        background: #1f2937;
        border-color: #374151;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.45);
      }

      body.theme-dark .share-tooltip::before {
        border-color: #374151;
      }

      body.theme-dark .share-tooltip-link {
        color: #e5e7eb;
      }

      body.theme-dark .share-tooltip-warning {
        background: linear-gradient(135deg, #3a3520, #2d2819);
        border-color: rgba(255, 193, 7, 0.4);
      }

      body.theme-dark .share-tooltip-warning-text {
        color: var(--color-dark-warning-text);
      }

      body.theme-dark .share-tooltip-btn {
        background: var(--color-dark-btn-bg);
        color: var(--color-dark-text);
      }

      body.theme-dark .share-tooltip-btn:hover {
        background: var(--color-dark-btn-bg-hover);
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        .documents-panel {
          padding: 10px;
        }

        .documents-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .doc-card {
          padding: 10px;
        }

        .doc-card-header {
          align-items: flex-start;
        }

        .doc-info {
          flex-direction: row;
          align-items: flex-start;
          gap: 8px;
          flex: 1;
          min-width: 0;
        }

        .doc-meta {
          flex: 1;
          min-width: 0;
        }

        .doc-meta-row {
          flex-wrap: nowrap;
          overflow: hidden;
          align-items: center;
        }

        .doc-time {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          flex-shrink: 1;
          min-width: 0;
        }

        .doc-icon {
          font-size: 1.2rem;
          flex-shrink: 0;
        }

        .doc-actions {
          gap: 4px;
          align-self: flex-start;
        }

        .doc-action-btn {
          padding: 4px 6px;
          font-size: 0.8rem;
        }
      }

      /* Print styles for PDF export */
      @media print {
        @page {
          margin: 0.5in;
        }

        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        body {
          background: white !important;
          color: black !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        .container {
          margin: 0 !important;
          padding: 0 !important;
          max-width: none !important;
        }

        header,
        .documents-bar,
        .status-bar,
        .panel-header,
        .resizer,
        .shared-view-banner {
          display: none !important;
        }

        .editor-container {
          display: block !important;
          height: auto !important;
          min-height: auto !important;
          gap: 0 !important;
        }

        .panel {
          display: block !important;
          border: none !important;
          box-shadow: none !important;
          flex: none !important;
          width: 100% !important;
          height: auto !important;
          position: static !important;
          background: transparent !important;
        }

        .panel-content {
          height: auto !important;
        }

        #markdown-editor {
          display: none !important;
        }

        #editor-panel {
          display: none !important;
        }

        #preview {
          display: block !important;
          height: auto !important;
          padding: 0 !important;
          overflow: visible !important;
          font-size: 12pt;
          line-height: 1.5;
        }

        #preview h1,
        #preview h2,
        #preview h3,
        #preview h4,
        #preview h5,
        #preview h6 {
          page-break-after: avoid;
          margin-top: 1.5em;
          margin-bottom: 0.5em;
        }

        #preview p {
          orphans: 3;
          widows: 3;
          margin-bottom: 1em;
        }

        #preview pre {
          page-break-inside: avoid;
          margin: 1em 0;
        }

        #preview blockquote {
          page-break-inside: avoid;
          margin: 1em 0;
        }

        #preview table {
          page-break-inside: avoid;
        }

        #preview img {
          max-width: 100% !important;
          height: auto !important;
        }

        #preview hr {
          page-break-after: avoid;
        }
      }
    </style>
  </head>
  <body class="theme-light">
    <script>
      // ========================================
      // CONFIGURATION
      // ========================================
      const CONFIG = {
        AUTOSAVE_DEBOUNCE_DELAY: 300, // ms
        MAX_DOCUMENTS: 4,
        ICON_ANIMATION_DURATION: 500, // ms
        SAVE_FEEDBACK_DURATION: 1000, // ms
        RTL_THRESHOLD: 0.3, // Minimum RTL character ratio to trigger RTL layout
      };

      const STORAGE_KEYS = {
        DOCUMENT: (docId) => `mdp_doc_${docId}`,
        AUTOSAVE: (docId) => `mdp_docAutosave_${docId}`,
        CURRENT_DOC_ID: "mdp_currentDocumentId",
        VISIBLE_DOCS: "mdp_visibleDocuments",
        DOCS_COLLAPSED: "mdp_docsCollapsed",
        THEME: "mdp_darkTheme",
        EDITOR_WIDTH: "mdp_editorWidth",
        PREVIEW_WIDTH: "mdp_previewWidth",
      };

      const ICONS = {
        SYNCED: "#icon-synced",
        UNSYNCED: "#icon-unsynced",
        CHECK: "#icon-check",
        SAVE: "#icon-save",
        SUN: "#icon-sun",
        MOON: "#icon-moon",
        COPY: "#icon-copy",
        SHARE: "#icon-share",
      };

      // Apply theme immediately before page renders to prevent FOUC
      (function () {
        const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME);
        let isDark;

        if (savedTheme !== null) {
          // User has manually chosen a theme
          isDark = savedTheme === "true";
        } else {
          // No manual preference, use system preference
          isDark =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;
        }

        if (isDark) {
          document.body.classList.remove("theme-light");
          document.body.classList.add("theme-dark");
        }
      })();
    </script>
    <!-- SVG Icon Definitions -->
    <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <!-- Sync Icon for Autosave -->
        <symbol id="icon-synced" viewBox="0 0 50 50">
          <path
            d="M 25 5 C 14.351019 5 5.6327898 13.379371 5.0546875 23.890625 A 2.0002 2.0002 0 1 0 9.0488281 24.109375 C 9.5127258 15.674629 16.440981 9 25 9 C 29.585377 9 33.698893 10.923932 36.611328 14 L 34 14 A 2.0002 2.0002 0 1 0 34 18 L 40.259766 18 A 2.0002 2.0002 0 0 0 40.947266 18 L 44 18 L 44 8 A 2.0002 2.0002 0 0 0 41.970703 5.9726562 A 2.0002 2.0002 0 0 0 40 8 L 40 11.777344 C 36.331862 7.6219929 30.96385 5 25 5 z M 43.03125 23.972656 A 2.0002 2.0002 0 0 0 40.951172 25.890625 C 40.487274 34.325371 33.559019 41 25 41 C 20.415217 41 16.302757 39.075684 13.390625 36 L 16 36 A 2.0002 2.0002 0 1 0 16 32 L 9.7167969 32 A 2.0002 2.0002 0 0 0 9.0878906 32 L 6 32 L 6 42 A 2.0002 2.0002 0 1 0 10 42 L 10 38.222656 C 13.668024 42.378116 19.036811 45 25 45 C 35.648981 45 44.36721 36.620629 44.945312 26.109375 A 2.0002 2.0002 0 0 0 43.03125 23.972656 z"
          />
        </symbol>

        <symbol id="icon-unsynced" viewBox="0 0 50 50">
          <path
            d="M 0.99023438 -0.009765625 A 1.0001 1.0001 0 0 0 0.29296875 1.7070312 L 10.166016 11.580078 L 12.990234 14.404297 L 48.292969 49.707031 A 1.0001 1.0001 0 1 0 49.707031 48.292969 L 39.808594 38.394531 C 42.776632 35.114312 44.684639 30.8495 44.945312 26.111328 C 45.006312 25.007328 44.161594 24.063906 43.058594 24.003906 C 41.948594 23.937906 41.012172 24.787625 40.951172 25.890625 C 40.74653 29.607723 39.265567 32.95183 36.96875 35.554688 L 14.417969 13.003906 C 17.248552 10.515019 20.951865 9 25 9 C 29.425438 9 33.614216 10.857691 36.603516 14 L 34 14 A 2.0002 2.0002 0 1 0 34 18 L 44 18 L 44 8 A 2.0002 2.0002 0 0 0 41.970703 5.9726562 A 2.0002 2.0002 0 0 0 40 8 L 40 11.775391 C 36.240947 7.5259484 30.778681 5 25 5 C 19.850441 5 15.142436 6.956176 11.583984 10.169922 L 1.7070312 0.29296875 A 1.0001 1.0001 0 0 0 0.99023438 -0.009765625 z M 8.8867188 13.128906 C 6.6397188 16.163906 5.2239531 19.858672 5.0019531 23.888672 C 4.9409531 24.992672 5.7856719 25.936094 6.8886719 25.996094 C 6.9276719 25.999094 6.9649531 26 7.0019531 26 C 8.0559531 26 8.9370938 25.175375 8.9960938 24.109375 C 9.1610937 21.100375 10.167766 18.333906 11.759766 16.003906 L 8.8867188 13.128906 z M 9.5449219 31.998047 C 9.5235732 31.99655 9.501883 32.000811 9.4804688 32 L 6 32 L 6 42 A 2.0002 2.0002 0 1 0 10 42 L 10 38.222656 C 13.759014 42.474011 19.22064 45 25 45 C 29.425 45 33.518797 43.538984 36.841797 41.083984 L 33.976562 38.220703 C 31.411563 39.970703 28.323 41 25 41 C 20.573911 41 16.38568 39.142081 13.396484 36 L 16 36 A 2.0002 2.0002 0 1 0 16 32 L 9.5566406 32 C 9.5526839 31.999699 9.5488812 31.998325 9.5449219 31.998047 z"
          />
        </symbol>

        <!-- Document Icon -->
        <symbol id="icon-document" viewBox="0 0 24 24">
          <path
            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
          <path
            d="M14 2v6h6M16 13H8M16 17H8M10 9H8"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </symbol>

        <!-- Trash/Delete Icon -->
        <symbol id="icon-trash" viewBox="0 0 24 24">
          <path
            d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>

        <!-- Save/Floppy Disk Icon -->
        <svg
          id="icon-save"
          viewBox="0 0 1024 1024"
          version="1.1"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M928 896V314.24c0-8.32-3.488-16.64-9.6-22.72l-187.84-186.24a31.36 31.36 0 0 0-22.4-9.28H672v160c0 52.8-43.2 96-96 96H256c-52.8 0-96-43.2-96-96V96H128c-17.6 0-32 14.4-32 32v768c0 17.6 14.4 32 32 32h64v-288c0-52.8 43.2-96 96-96h448c52.8 0 96 43.2 96 96v288h64c17.632 0 32-14.4 32-32z m-160 32v-288c0-17.6-14.368-32-32-32H288c-17.6 0-32 14.4-32 32v288h512zM224 96v160c0 17.6 14.4 32 32 32h320c17.632 0 32-14.4 32-32V96H224z m739.52 150.08c18.272 17.92 28.48 42.88 28.48 68.16V896c0 52.8-43.2 96-96 96H128c-52.8 0-96-43.2-96-96V128c0-52.8 43.2-96 96-96h580.16c25.632 0 49.632 9.92 67.52 27.84l187.84 186.24zM512 256a32 32 0 0 1-32-32V160a32 32 0 0 1 64 0v64a32 32 0 0 1-32 32z"
          />
        </svg>

        <!-- Sun/Moon Icon for Theme Toggle -->
        <symbol id="icon-sun" viewBox="0 0 24 24">
          <circle
            cx="12"
            cy="12"
            r="5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <path
            d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </symbol>

        <symbol id="icon-moon" viewBox="0 0 24 24">
          <path
            d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>

        <!-- Check Icon -->
        <symbol id="icon-check" viewBox="0 0 24 24">
          <polyline
            points="20 6 9 17 4 12"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>

        <!-- Plus/Add Icon -->
        <symbol id="icon-plus" viewBox="0 0 24 24">
          <path
            d="M12 5v14M5 12h14"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>

        <!-- Share/Link Icon -->
        <symbol id="icon-share" viewBox="0 0 24 24">
          <path
            d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
          <path
            d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>

        <!-- Share Alt Icon -->
        <symbol id="icon-share-alt" viewBox="0 0 24 24">
          <circle
            cx="18"
            cy="6"
            r="3"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <circle
            cx="18"
            cy="18"
            r="3"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <circle
            cx="6"
            cy="12"
            r="3"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <line
            x1="8.59"
            y1="10.41"
            x2="15.41"
            y2="7.59"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
          <line
            x1="8.59"
            y1="13.59"
            x2="15.41"
            y2="16.41"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </symbol>

        <!-- Copy Icon -->
        <symbol id="icon-copy" viewBox="0 0 24 24">
          <rect
            x="3"
            y="7"
            width="13"
            height="13"
            rx="2.5"
            ry="2.5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <path
            d="M8 7V5a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>

        <!-- PDF Icon -->
        <symbol id="icon-pdf" viewBox="0 0 24 24">
          <path
            d="M6 9V2h12v7"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
          <path
            d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
          <rect
            x="6"
            y="14"
            width="12"
            height="8"
            rx="1"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
          />
          <circle cx="18" cy="14" r="1" fill="currentColor" />
        </symbol>

        <!-- Download Icon -->
        <symbol id="icon-download" viewBox="0 0 24 24">
          <path
            d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M7 10l5 5 5-5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M12 15V3"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </symbol>

        <!-- GitHub Icon -->
        <symbol id="icon-github" viewBox="0 0 24 24">
          <path
            d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          />
        </symbol>
      </defs>
    </svg>

    <div class="container">
      <header>
        <div class="header-title">
          <h2>Markdown Previewer</h2>
        </div>
        <div class="header-controls">
          <div class="header-doc-info">
            <button class="doc-badge-btn" id="btn-toggle-docs-header">
              Doc<span id="current-doc-number-header"> 1</span>
            </button>
          </div>
          <div class="share-action">
            <button id="btn-share" title="Share this document">
              <span class="icon-svg"
                ><svg><use href="#icon-share" /></svg
              ></span>
            </button>
            <div
              id="share-tooltip"
              class="share-tooltip"
              role="tooltip"
              aria-hidden="true"
            >
              <div class="share-tooltip-row">
                <span class="share-tooltip-link" id="share-link-preview"></span>
                <div class="share-tooltip-actions">
                  <button
                    class="share-tooltip-btn"
                    id="share-copy-btn"
                    title="Copy link"
                    type="button"
                  >
                    <span class="icon-svg"
                      ><svg><use href="#icon-copy" /></svg
                    ></span>
                  </button>
                  <button
                    class="share-tooltip-btn"
                    id="share-native-btn"
                    title="Share link"
                    type="button"
                  >
                    <span class="icon-svg"
                      ><svg><use href="#icon-share-alt" /></svg
                    ></span>
                  </button>
                </div>
              </div>
              <div
                class="share-tooltip-warning"
                id="share-tooltip-warning"
                style="display: none"
              >
                <span class="share-tooltip-warning-text"></span>
              </div>
            </div>
          </div>
          <button id="btn-theme-toggle">
            <span class="icon-svg"
              ><svg><use href="#icon-sun" /></svg
            ></span>
          </button>
        </div>
      </header>

      <!-- Shared View Banner -->
      <div class="shared-view-banner hidden" id="shared-view-banner">
        <div class="shared-banner-content">
          <span class="shared-banner-icon icon-svg">
            <svg><use href="#icon-share-alt" /></svg>
          </span>
          <div class="shared-banner-text">
            <div class="shared-banner-title">Viewing Shared Content</div>
            <div class="shared-banner-subtitle">
              Save to keep it in the browser
            </div>
          </div>
        </div>
        <div class="shared-banner-actions">
          <button class="btn-save-to-slot" id="btn-save-from-banner">
            Save
          </button>
        </div>
      </div>

      <!-- Documents Bar -->
      <div class="documents-bar" id="documents-bar">
        <div class="documents-panel" id="documents-panel">
          <div class="documents-grid">
            <!-- Document 1 -->
            <div class="doc-card" data-doc="1">
              <div class="doc-card-header">
                <div class="doc-info">
                  <div class="doc-icon">
                    <span class="icon-svg icon-svg-large"
                      ><svg><use href="#icon-document" /></svg
                    ></span>
                  </div>
                  <div class="doc-meta">
                    <span class="doc-label">Doc 1</span>
                    <div class="doc-meta-row">
                      <div
                        class="doc-autosave-badge enabled"
                        title="Autosave enabled"
                      >
                        <span class="icon-svg"
                          ><svg><use href="#icon-synced" /></svg
                        ></span>
                      </div>
                      <span class="doc-time"></span>
                    </div>
                  </div>
                </div>
                <div class="doc-actions">
                  <button
                    class="doc-action-btn delete-btn"
                    title="Remove document"
                    disabled
                  >
                    <span class="icon-svg"
                      ><svg><use href="#icon-trash" /></svg
                    ></span>
                  </button>
                </div>
              </div>
              <div class="doc-preview">
                <div class="doc-preview-text">Empty document</div>
              </div>
            </div>

            <!-- Document 2 -->
            <div class="doc-card" data-doc="2">
              <div class="doc-card-header">
                <div class="doc-info">
                  <div class="doc-icon">
                    <span class="icon-svg icon-svg-large"
                      ><svg><use href="#icon-document" /></svg
                    ></span>
                  </div>
                  <div class="doc-meta">
                    <span class="doc-label">Doc 2</span>
                    <div class="doc-meta-row">
                      <div
                        class="doc-autosave-badge enabled"
                        title="Autosave enabled"
                      >
                        <span class="icon-svg"
                          ><svg><use href="#icon-synced" /></svg
                        ></span>
                      </div>
                      <span class="doc-time"></span>
                    </div>
                  </div>
                </div>
                <div class="doc-actions">
                  <button
                    class="doc-action-btn delete-btn"
                    title="Remove document"
                  >
                    <span class="icon-svg"
                      ><svg><use href="#icon-trash" /></svg
                    ></span>
                  </button>
                </div>
              </div>
              <div class="doc-preview">
                <div class="doc-preview-text">Empty document</div>
              </div>
            </div>

            <!-- Document 3 -->
            <div class="doc-card" data-doc="3">
              <div class="doc-card-header">
                <div class="doc-info">
                  <div class="doc-icon">
                    <span class="icon-svg icon-svg-large"
                      ><svg><use href="#icon-document" /></svg
                    ></span>
                  </div>
                  <div class="doc-meta">
                    <span class="doc-label">Doc 3</span>
                    <div class="doc-meta-row">
                      <div
                        class="doc-autosave-badge enabled"
                        title="Autosave enabled"
                      >
                        <span class="icon-svg"
                          ><svg><use href="#icon-synced" /></svg
                        ></span>
                      </div>
                      <span class="doc-time"></span>
                    </div>
                  </div>
                </div>
                <div class="doc-actions">
                  <button
                    class="doc-action-btn delete-btn"
                    title="Remove document"
                  >
                    <span class="icon-svg"
                      ><svg><use href="#icon-trash" /></svg
                    ></span>
                  </button>
                </div>
              </div>
              <div class="doc-preview">
                <div class="doc-preview-text">Empty document</div>
              </div>
            </div>

            <!-- Document 4 -->
            <div class="doc-card" data-doc="4">
              <div class="doc-card-header">
                <div class="doc-info">
                  <div class="doc-icon">
                    <span class="icon-svg icon-svg-large"
                      ><svg><use href="#icon-document" /></svg
                    ></span>
                  </div>
                  <div class="doc-meta">
                    <span class="doc-label">Doc 4</span>
                    <div class="doc-meta-row">
                      <div
                        class="doc-autosave-badge enabled"
                        title="Autosave enabled"
                      >
                        <span class="icon-svg"
                          ><svg><use href="#icon-synced" /></svg
                        ></span>
                      </div>
                      <span class="doc-time"></span>
                    </div>
                  </div>
                </div>
                <div class="doc-actions">
                  <button
                    class="doc-action-btn delete-btn"
                    title="Remove document"
                  >
                    <span class="icon-svg"
                      ><svg><use href="#icon-trash" /></svg
                    ></span>
                  </button>
                </div>
              </div>
              <div class="doc-preview">
                <div class="doc-preview-text">Empty document</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="editor-container">
        <div class="panel" id="editor-panel">
          <div class="panel-header">
            <div>Editor</div>
            <div class="panel-controls">
              <button
                class="manual-save-btn-split"
                id="manual-save-split"
                title="Save now"
              >
                <span class="icon-svg"
                  ><svg><use href="#icon-save" /></svg
                ></span>
              </button>
              <button
                class="autosave-toggle-btn"
                id="autosave-toggle-header"
                title="Toggle autosave"
              >
                <span id="autosave-status-header"
                  ><span class="icon-svg"
                    ><svg><use href="#icon-synced" /></svg
                  ></span>
                </span>
              </button>
              <button id="btn-copy-markdown" title="Copy Markdown">
                <span class="icon-svg"
                  ><svg><use href="#icon-copy" /></svg
                ></span>
              </button>
            </div>
          </div>

          <div class="panel-content">
            <textarea
              id="markdown-editor"
              placeholder="Write your Markdown here..."
            ></textarea>
          </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="panel" id="preview-panel">
          <div class="panel-header">
            <div>Preview</div>
            <div class="panel-controls">
              <button id="btn-save-markdown" title="Save as file">
                <span class="icon-svg"
                  ><svg><use href="#icon-download" /></svg
                ></span>
              </button>
              <button id="btn-export-pdf" title="Export as PDF">
                <span class="icon-svg"
                  ><svg><use href="#icon-pdf" /></svg
                ></span>
              </button>
            </div>
          </div>
          <div class="panel-content">
            <div id="preview"></div>
          </div>
        </div>
      </div>

      <div class="status-bar">
        <div id="word-count">Words: 0 | Chars: 0</div>
        <div class="status-center">
          <a
            href="https://github.com/alireza-malek/markdown-previewer"
            target="_blank"
            rel="noopener noreferrer"
            class="github-link"
            title="View on GitHub"
          >
            <span class="icon-svg">
              <svg><use href="#icon-github" /></svg>
            </span>
          </a>
        </div>
        <div id="current-time"></div>
      </div>
    </div>

    <!-- Mini Modal Root -->
    <div class="mini-modal-overlay" id="mini-modal">
      <div class="mini-modal" role="dialog" aria-modal="true">
        <div class="mini-modal-body" id="mini-modal-message"></div>
        <div class="mini-modal-actions" id="mini-modal-actions"></div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // RTL detection regex - cached for performance
        const RTL_REGEX =
          /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;

        // ========================================
        // DOM REFERENCES
        // ========================================
        const markdownEditor = document.getElementById("markdown-editor");
        const preview = document.getElementById("preview");
        const wordCount = document.getElementById("word-count");
        const currentTime = document.getElementById("current-time");
        const btnThemeToggle = document.getElementById("btn-theme-toggle");
        const btnCopyMarkdown = document.getElementById("btn-copy-markdown");
        const btnSaveMarkdown = document.getElementById("btn-save-markdown");
        const btnExportPdf = document.getElementById("btn-export-pdf");
        const btnToggleDocsHeader = document.getElementById(
          "btn-toggle-docs-header"
        );
        const documentsBar = document.getElementById("documents-bar");
        const currentDocNumberHeader = document.getElementById(
          "current-doc-number-header"
        );
        const autosaveStatusHeader = document.getElementById(
          "autosave-status-header"
        );
        const autosaveToggleHeader = document.getElementById(
          "autosave-toggle-header"
        );
        const manualSaveSplit = document.getElementById("manual-save-split");
        const miniModal = document.getElementById("mini-modal");
        const miniModalMessage = document.getElementById("mini-modal-message");
        const miniModalActions = document.getElementById("mini-modal-actions");
        const toastContainer = document.getElementById("toast-container");

        // Initialize marked with syntax highlighting
        marked.setOptions({
          renderer: new marked.Renderer(),
          highlight: function (code, language) {
            if (language && hljs.getLanguage(language)) {
              try {
                return hljs.highlight(code, { language }).value;
              } catch (e) {}
            }
            return hljs.highlightAuto(code).value;
          },
          langPrefix: "hljs language-",
          pedantic: false,
          gfm: true,
          breaks: true,
          sanitize: false,
          smartypants: false,
          xhtml: false,
        });

        // ========================================
        // MINI MODAL HELPERS
        // ========================================
        function showModal({ message = "", actions = [] }) {
          return new Promise((resolve) => {
            miniModalMessage.textContent = message;
            miniModalActions.innerHTML = "";

            actions.forEach((action) => {
              const btn = document.createElement("button");
              // Reuse existing styles: primary uses default button; secondary uses doc-action-btn
              btn.className = "doc-action-btn";
              btn.type = "button";
              btn.textContent = action.label;
              btn.addEventListener("click", () => {
                closeModal();
                resolve(action.value);
              });
              miniModalActions.appendChild(btn);
            });

            function closeOnBackdrop(e) {
              if (e.target === miniModal) {
                miniModal.removeEventListener("click", closeOnBackdrop);
                closeModal();
                resolve(null);
              }
            }

            function onKey(e) {
              if (e.key === "Escape") {
                document.removeEventListener("keydown", onKey);
                closeModal();
                resolve(null);
              }
            }

            miniModal.addEventListener("click", closeOnBackdrop);
            document.addEventListener("keydown", onKey);

            openModal();
          });
        }

        function openModal() {
          miniModal.classList.add("is-visible");
          miniModal.setAttribute("aria-hidden", "false");
        }

        function closeModal() {
          miniModal.classList.remove("is-visible");
          miniModal.setAttribute("aria-hidden", "true");
        }

        function showConfirm(
          message,
          { title = "", confirmText = "OK", cancelText = "Cancel" } = {}
        ) {
          return showModal({
            message,
            actions: [
              { label: cancelText, value: false },
              { label: confirmText, value: true, primary: true },
            ],
          }).then((v) => !!v);
        }
        // ========================================
        // TOASTS
        // ========================================
        function showToast(message, durationMs = 6000) {
          return new Promise((resolve) => {
            const toast = document.createElement("div");
            toast.className = "mini-toast";
            toast.textContent = message;

            const progress = document.createElement("div");
            progress.className = "toast-progress";
            const bar = document.createElement("div");
            bar.className = "toast-progress-bar";
            progress.appendChild(bar);
            toast.appendChild(progress);

            toastContainer.appendChild(toast);

            // Force layout, then animate width
            requestAnimationFrame(() => {
              bar.style.transitionDuration = durationMs + "ms";
              bar.style.width = "0%";
            });

            const timer = setTimeout(() => {
              cleanup();
              resolve(true);
            }, durationMs);

            function cleanup() {
              clearTimeout(timer);
              if (toast.parentNode) toast.parentNode.removeChild(toast);
            }

            toast.addEventListener("click", cleanup);
          });
        }

        function flashButtonCheck(buttonEl) {
          if (!buttonEl) return;
          const original = buttonEl.innerHTML;
          buttonEl.innerHTML = `<span class="icon-svg"><svg><use href="${ICONS.CHECK}"/></svg></span>`;
          setTimeout(() => {
            buttonEl.innerHTML = original;
          }, CONFIG.SAVE_FEEDBACK_DURATION);
        }

        // ========================================
        // PANEL SIZING & RESIZING
        // ========================================
        function initPanelSizes() {
          const savedEditorWidth = localStorage.getItem(
            STORAGE_KEYS.EDITOR_WIDTH
          );
          const savedPreviewWidth = localStorage.getItem(
            STORAGE_KEYS.PREVIEW_WIDTH
          );

          if (savedEditorWidth && savedPreviewWidth) {
            document.getElementById("editor-panel").style.flex =
              savedEditorWidth;
            document.getElementById("preview-panel").style.flex =
              savedPreviewWidth;
          } else {
            // Default is 50/50
            document.getElementById("editor-panel").style.flex = "1";
            document.getElementById("preview-panel").style.flex = "1";
          }
        }

        // Set up the resizer
        function setupResizer() {
          const resizer = document.getElementById("resizer");
          const editorPanel = document.getElementById("editor-panel");
          const previewPanel = document.getElementById("preview-panel");

          let isResizing = false;
          let initialX, initialEditorFlex, initialPreviewFlex;

          resizer.addEventListener("mousedown", function (e) {
            isResizing = true;
            resizer.classList.add("active");

            initialX = e.clientX;
            // Get the flex property directly instead of flexGrow for better cross-browser compatibility
            const editorFlex = getComputedStyle(editorPanel).flex;
            const previewFlex = getComputedStyle(previewPanel).flex;

            // Parse flex values - handle cases where flex might be "1 1 0%" or just "1"
            initialEditorFlex = parseFloat(editorFlex.split(" ")[0] || "1");
            initialPreviewFlex = parseFloat(previewFlex.split(" ")[0] || "1");

            document.addEventListener("mousemove", resize);
            document.addEventListener("mouseup", stopResize);
          });

          function resize(e) {
            if (!isResizing) return;

            const deltaX = e.clientX - initialX;
            const containerWidth =
              editorPanel.parentNode.clientWidth - resizer.offsetWidth;
            const percentageDelta = deltaX / containerWidth;

            const totalFlex = initialEditorFlex + initialPreviewFlex;
            const flexDelta = percentageDelta * totalFlex;

            let newEditorFlex = Math.max(0.1, initialEditorFlex + flexDelta);
            let newPreviewFlex = Math.max(0.1, initialPreviewFlex - flexDelta);

            // Auto-snap to center when close to 50/50 split
            const centerThreshold = 0.03; // Snap when within 3% of center
            if (
              Math.abs(newEditorFlex - 1) < centerThreshold &&
              Math.abs(newPreviewFlex - 1) < centerThreshold
            ) {
              newEditorFlex = 1;
              newPreviewFlex = 1;
            }

            editorPanel.style.flex = newEditorFlex;
            previewPanel.style.flex = newPreviewFlex;

            // Save the new dimensions
            localStorage.setItem(STORAGE_KEYS.EDITOR_WIDTH, newEditorFlex);
            localStorage.setItem(STORAGE_KEYS.PREVIEW_WIDTH, newPreviewFlex);
          }

          function stopResize() {
            isResizing = false;
            resizer.classList.remove("active");

            document.removeEventListener("mousemove", resize);
            document.removeEventListener("mouseup", stopResize);
          }

          // Handle window resize
          window.addEventListener("resize", function () {
            // Make sure flex proportions are maintained
            editorPanel.style.flex =
              localStorage.getItem(STORAGE_KEYS.EDITOR_WIDTH) || 1;
            previewPanel.style.flex =
              localStorage.getItem(STORAGE_KEYS.PREVIEW_WIDTH) || 1;
          });
        }

        // ========================================
        // RTL DETECTION
        // ========================================
        function isRTL(text) {
          if (!text || typeof text !== "string") return false;

          const totalChars = text.replace(/\s/g, "").length;
          if (totalChars === 0) return false;

          // Count RTL characters
          let rtlCount = 0;
          for (let i = 0; i < text.length; i++) {
            if (RTL_REGEX.test(text[i])) {
              rtlCount++;
            }
          }

          // Only consider RTL if RTL characters exceed the threshold
          return rtlCount / totalChars > CONFIG.RTL_THRESHOLD;
        }

        // Function to apply RTL detection to elements
        function applyRTLDetection(element) {
          // Check paragraphs, headings, and blockquotes
          element
            .querySelectorAll("p, h1, h2, h3, h4, h5, h6, blockquote")
            .forEach((el) => {
              if (isRTL(el.textContent)) {
                el.classList.add("rtl-text");
              } else {
                el.classList.remove("rtl-text");
              }
            });

          // Check list items individually
          element.querySelectorAll("li").forEach((li) => {
            if (isRTL(li.textContent)) {
              li.classList.add("rtl-text");
            } else {
              li.classList.remove("rtl-text");
            }
          });

          // Check if entire lists are RTL
          element.querySelectorAll("ul, ol").forEach((list) => {
            const allItemsRTL = Array.from(list.children).every(
              (li) => li.tagName === "LI" && isRTL(li.textContent)
            );
            if (allItemsRTL) {
              list.classList.add("rtl-text");
            } else {
              list.classList.remove("rtl-text");
            }
          });

          // Check table cells individually
          element.querySelectorAll("th, td").forEach((cell) => {
            if (isRTL(cell.textContent)) {
              cell.classList.add("rtl-text");
            } else {
              cell.classList.remove("rtl-text");
            }
          });
        }

        // Render markdown function
        function renderMarkdown() {
          const markdownText = markdownEditor.value;
          const html = marked.parse(markdownText);
          preview.innerHTML = html;

          // Apply syntax highlighting to code blocks
          document.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
          });

          // Apply RTL detection
          applyRTLDetection(preview);

          // Update word count
          const words = markdownText.match(/\S+/g) || [];
          wordCount.textContent = `Words: ${words.length} | Chars: ${markdownText.length}`;
        }

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        let currentDocumentId = 1;
        let visibleDocuments = [1]; // Track which documents are currently visible
        let addDocBtn = null; // Reference to the add document button
        let isSharedViewMode = false; // Track if we're in shared view mode
        let sharedContent = null; // Store shared content temporarily

        // ========================================
        // STORAGE HELPER FUNCTIONS
        // ========================================
        function getPreviewText(text, maxLines = 3) {
          const lines = text
            .split("\n")
            .filter((l) => l.trim())
            .slice(0, maxLines);
          return lines.join("\n") || "Empty document";
        }

        function getRelativeTime(timestamp) {
          const now = new Date();
          const date = new Date(timestamp);
          const diffInSeconds = Math.floor((now - date) / 1000);

          if (diffInSeconds < 60) {
            return diffInSeconds <= 1
              ? "just now"
              : `${diffInSeconds} seconds ago`;
          }

          const diffInMinutes = Math.floor(diffInSeconds / 60);
          if (diffInMinutes < 60) {
            return diffInMinutes === 1
              ? "1 minute ago"
              : `${diffInMinutes} minutes ago`;
          }

          const diffInHours = Math.floor(diffInMinutes / 60);
          if (diffInHours < 24) {
            return diffInHours === 1
              ? "1 hour ago"
              : `${diffInHours} hours ago`;
          }

          const diffInDays = Math.floor(diffInHours / 24);
          if (diffInDays < 7) {
            return diffInDays === 1 ? "1 day ago" : `${diffInDays} days ago`;
          }

          const diffInWeeks = Math.floor(diffInDays / 7);
          if (diffInWeeks < 4) {
            return diffInWeeks === 1
              ? "1 week ago"
              : `${diffInWeeks} weeks ago`;
          }

          const diffInMonths = Math.floor(diffInDays / 30);
          if (diffInMonths < 12) {
            return diffInMonths === 1
              ? "1 month ago"
              : `${diffInMonths} months ago`;
          }

          const diffInYears = Math.floor(diffInDays / 365);
          return diffInYears === 1 ? "1 year ago" : `${diffInYears} years ago`;
        }

        function loadDocument(docId) {
          const docData = localStorage.getItem(STORAGE_KEYS.DOCUMENT(docId));
          if (docData) {
            try {
              const data = JSON.parse(docData);
              return data;
            } catch (e) {
              return { content: "", timestamp: null };
            }
          }
          return { content: "", timestamp: null };
        }

        function saveDocument(docId, content) {
          const data = {
            content: content,
            timestamp: new Date().toISOString(),
          };
          localStorage.setItem(
            STORAGE_KEYS.DOCUMENT(docId),
            JSON.stringify(data)
          );
          updateDocumentDisplay(docId);

          // Update indicator if saving current doc
          if (docId === currentDocumentId) {
            updateCurrentDocIndicator();
          }
        }

        function isAutosaveEnabled(docId) {
          const saved = localStorage.getItem(STORAGE_KEYS.AUTOSAVE(docId));
          return saved === null || saved === "true"; // Default to true
        }

        function setAutosaveEnabled(docId, enabled) {
          localStorage.setItem(
            STORAGE_KEYS.AUTOSAVE(docId),
            enabled.toString()
          );
          updateCurrentDocIndicator();
        }

        function updateCurrentDocIndicator() {
          // In shared view mode, show special indicator
          if (isSharedViewMode) {
            btnToggleDocsHeader.textContent = "Docs";
            autosaveStatusHeader.innerHTML = `<span class="icon-svg"><svg><use href="${ICONS.UNSYNCED}"/></svg></span>`;
            autosaveToggleHeader.classList.add("off");
            autosaveToggleHeader.title = "Shared content (autosave disabled)";
            manualSaveSplit.classList.remove("visible");
            autosaveToggleHeader.style.pointerEvents = "none";
            autosaveToggleHeader.style.opacity = "0.6";
            return;
          }

          // Reset pointer events and opacity for normal mode
          autosaveToggleHeader.style.pointerEvents = "";
          autosaveToggleHeader.style.opacity = "";

          currentDocNumberHeader.textContent = currentDocumentId;
          btnToggleDocsHeader.textContent =
            "Doc " + currentDocNumberHeader.textContent;

          const autosaveEnabled = isAutosaveEnabled(currentDocumentId);

          if (autosaveEnabled) {
            autosaveStatusHeader.innerHTML = `<span class="icon-svg"><svg><use href="${ICONS.SYNCED}"/></svg></span>`;
            autosaveToggleHeader.classList.remove("off");
            autosaveToggleHeader.title = "Autosave: ON - Click to disable";
            manualSaveSplit.classList.remove("visible");
          } else {
            autosaveStatusHeader.innerHTML = `<span class="icon-svg"><svg><use href="${ICONS.UNSYNCED}"/></svg></span>`;
            autosaveToggleHeader.classList.add("off");
            autosaveToggleHeader.title = "Autosave: OFF - Click to enable";
            manualSaveSplit.classList.add("visible");
          }
        }

        function updateDocumentDisplay(docId) {
          const card = document.querySelector(`[data-doc="${docId}"]`);
          const docData = loadDocument(docId);
          const previewText = card.querySelector(".doc-preview-text");
          const timeEl = card.querySelector(".doc-time");

          const isEmpty = !docData.content.trim();

          // Update preview
          if (!isEmpty) {
            previewText.textContent = getPreviewText(docData.content);
            previewText.classList.remove("empty");
          } else {
            previewText.textContent = "Empty document";
            previewText.classList.add("empty");
          }

          // Update timestamp (hide for empty docs)
          if (!isEmpty && docData.timestamp) {
            const date = new Date(docData.timestamp);
            timeEl.textContent = getRelativeTime(docData.timestamp);
            timeEl.title = date.toLocaleString(); // Show absolute time on hover
          } else {
            timeEl.textContent = "";
            timeEl.title = "";
          }

          // Update autosave badge
          const autosaveBadge = card.querySelector(".doc-autosave-badge");
          const autosaveEnabled = isAutosaveEnabled(docId);
          if (autosaveEnabled) {
            autosaveBadge.classList.add("enabled");
            autosaveBadge.classList.remove("disabled");
            autosaveBadge.title = "Autosave enabled";
            autosaveBadge.innerHTML = `<span class="icon-svg"><svg><use href="#icon-synced"/></svg></span>`;
          } else {
            autosaveBadge.classList.add("disabled");
            autosaveBadge.classList.remove("enabled");
            autosaveBadge.title = "Autosave disabled";
            autosaveBadge.innerHTML = `<span class="icon-svg"><svg><use href="#icon-unsynced"/></svg></span>`;
          }

          // Update active state
          if (parseInt(docId) === currentDocumentId && !isSharedViewMode) {
            card.classList.add("active");
          } else {
            card.classList.remove("active");
          }
        }

        function updateAllDocumentTimes() {
          for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
            const card = document.querySelector(`[data-doc="${i}"]`);
            if (card && card.style.display !== "none") {
              const docData = loadDocument(i);
              if (docData.content.trim() && docData.timestamp) {
                const timeEl = card.querySelector(".doc-time");
                const date = new Date(docData.timestamp);
                timeEl.textContent = getRelativeTime(docData.timestamp);
                timeEl.title = date.toLocaleString();
              }
            }
          }
        }

        function switchToDocument(docId) {
          // If in shared view mode, ask user to save or discard
          if (isSharedViewMode) {
            showConfirm(
              "You're viewing shared content. Switching documents will discard this content.\n\nAre you sure you want to switch?",
              {
                confirmText: "Switch without saving",
                cancelText: "Cancel",
              }
            ).then((switchWithoutSaving) => {
              if (switchWithoutSaving) {
                exitSharedViewMode();
                switchToDocument(docId);
              } else {
                return;
              }
            });
            return;
          }

          // Switch to new document
          currentDocumentId = docId;
          localStorage.setItem(
            STORAGE_KEYS.CURRENT_DOC_ID,
            currentDocumentId.toString()
          );
          const docData = loadDocument(docId);
          markdownEditor.value = docData.content;
          renderMarkdown();

          // Update all document displays
          for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
            updateDocumentDisplay(i);
          }

          // Update current doc indicator
          updateCurrentDocIndicator();
        }

        function createAddDocumentButton() {
          const btn = document.createElement("div");
          btn.className = "add-doc-btn";
          btn.id = "add-doc-btn";
          btn.innerHTML = `
            <span class="plus-icon">+</span>
            <div class="add-text">Add Document</div>
          `;
          btn.addEventListener("click", addNewDocument);
          return btn;
        }

        function positionAddButton() {
          const documentsGrid = document.querySelector(".documents-grid");

          // Remove existing add button if it exists
          if (addDocBtn && addDocBtn.parentNode) {
            addDocBtn.parentNode.removeChild(addDocBtn);
          }

          // If we haven't reached max documents, create and position the add button
          if (visibleDocuments.length < CONFIG.MAX_DOCUMENTS) {
            if (!addDocBtn) {
              addDocBtn = createAddDocumentButton();
            }

            // Find the last visible document in DOM order
            let lastVisibleCard = null;
            for (let i = 4; i >= 1; i--) {
              if (visibleDocuments.includes(i)) {
                lastVisibleCard = document.querySelector(`[data-doc="${i}"]`);
                break;
              }
            }

            if (lastVisibleCard) {
              // Insert after the last visible document
              lastVisibleCard.parentNode.insertBefore(
                addDocBtn,
                lastVisibleCard.nextSibling
              );
            }
          }
        }

        function removeDocument(docId) {
          // Prevent removal of Document 1
          if (docId === 1) {
            showToast(
              "Document 1 cannot be removed. It serves as the primary document."
            );
            return;
          }

          // Check if document is empty - if so, remove without confirmation
          const docData = loadDocument(docId);
          const isEmpty = !docData.content.trim();

          if (isEmpty) {
            // Remove empty document without confirmation
            localStorage.removeItem(STORAGE_KEYS.DOCUMENT(docId));
            localStorage.removeItem(STORAGE_KEYS.AUTOSAVE(docId));

            // Hide the document
            hideDocument(docId);

            // If this is the current document, switch to the first available document
            if (currentDocumentId === docId) {
              const firstAvailableDoc =
                visibleDocuments.length > 0 ? visibleDocuments[0] : 1;
              switchToDocument(firstAvailableDoc);
            }

            // Reposition the add button
            positionAddButton();

            // Update the display (though the card is now hidden)
            updateDocumentDisplay(docId);
          } else {
            // Show confirmation for non-empty documents
            showConfirm(
              `Delete document ${docId}?\n\nThis will permanently delete all its content.`,
              { confirmText: "Delete", cancelText: "Cancel" }
            ).then((proceed) => {
              if (!proceed) return;
              // Clear the document data from localStorage
              localStorage.removeItem(STORAGE_KEYS.DOCUMENT(docId));
              localStorage.removeItem(STORAGE_KEYS.AUTOSAVE(docId));

              // Hide the document
              hideDocument(docId);

              // If this is the current document, switch to the first available document
              if (currentDocumentId === docId) {
                const firstAvailableDoc =
                  visibleDocuments.length > 0 ? visibleDocuments[0] : 1;
                switchToDocument(firstAvailableDoc);
              }

              // Reposition the add button
              positionAddButton();

              // Update the display (though the card is now hidden)
              updateDocumentDisplay(docId);

              // Show toast notification
              showToast(`Document ${docId} has been deleted.`);
            });
          }
        }

        function showDocument(docId) {
          const docCard = document.querySelector(`[data-doc="${docId}"]`);
          if (docCard && !visibleDocuments.includes(docId)) {
            docCard.style.display = "block";
            visibleDocuments.push(docId);
            visibleDocuments.sort((a, b) => a - b);
            // Save the updated visible documents state
            localStorage.setItem(
              STORAGE_KEYS.VISIBLE_DOCS,
              JSON.stringify(visibleDocuments)
            );
            // Update delete button states for all documents
            for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
              updateDocumentDisplay(i);
            }
            // Reposition the add button
            positionAddButton();
          }
        }

        function hideDocument(docId) {
          const docCard = document.querySelector(`[data-doc="${docId}"]`);
          if (docCard && docId !== 1 && visibleDocuments.includes(docId)) {
            docCard.style.display = "none";
            visibleDocuments = visibleDocuments.filter((id) => id !== docId);
            // Save the updated visible documents state
            localStorage.setItem(
              STORAGE_KEYS.VISIBLE_DOCS,
              JSON.stringify(visibleDocuments)
            );
            // Update delete button states for all documents
            for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
              updateDocumentDisplay(i);
            }
            // Reposition the add button
            positionAddButton();
          }
        }

        function addNewDocument() {
          if (visibleDocuments.length >= CONFIG.MAX_DOCUMENTS) return;

          // Find the next available document ID (2, 3, or 4)
          for (let i = 2; i <= CONFIG.MAX_DOCUMENTS; i++) {
            if (!visibleDocuments.includes(i)) {
              showDocument(i);
              // Add button is repositioned in showDocument()
              break;
            }
          }
        }

        function toggleDocumentsPanel() {
          documentsBar.classList.toggle("collapsed");

          // Update doc badge button active state
          const isCollapsed = documentsBar.classList.contains("collapsed");
          if (isCollapsed) {
            btnToggleDocsHeader.classList.remove("active");
          } else {
            btnToggleDocsHeader.classList.add("active");
          }

          // Save state
          localStorage.setItem(
            STORAGE_KEYS.DOCS_COLLAPSED,
            isCollapsed.toString()
          );
        }

        // ========================================
        // SHARE BY LINK FUNCTIONS
        // ========================================
        function compressContent(content) {
          return LZString.compressToEncodedURIComponent(content);
        }

        function decompressContent(compressed) {
          try {
            const content =
              LZString.decompressFromEncodedURIComponent(compressed);
            return content ? { content } : null;
          } catch (e) {
            console.error("Failed to decompress content:", e);
            return null;
          }
        }

        function generateShareLink() {
          const content = markdownEditor.value;
          if (!content.trim()) {
            showToast("Cannot share an empty document.");
            return null;
          }

          const compressed = compressContent(content);
          const url = `${window.location.href.split("#")[0]}#s=${compressed}`;

          return { url, length: url.length };
        }

        function enterSharedViewMode(content, timestamp) {
          isSharedViewMode = true;
          sharedContent = content;

          // Load content into editor
          markdownEditor.value = content;
          renderMarkdown();

          // Show banner
          const banner = document.getElementById("shared-view-banner");
          banner.classList.remove("hidden");
          document.body.classList.add("has-shared-banner");

          // Push current URL to history so back button works
          const currentUrl = window.location.href;
          history.pushState({ sharedView: true }, "", currentUrl);

          // Update header to reflect shared mode
          updateCurrentDocIndicator();
        }

        function exitSharedViewMode() {
          isSharedViewMode = false;
          sharedContent = null;

          // Hide banner
          const banner = document.getElementById("shared-view-banner");
          banner.classList.add("hidden");
          document.body.classList.remove("has-shared-banner");

          // Clear fragment from current URL
          history.replaceState(null, "", window.location.pathname);

          // Update header
          updateCurrentDocIndicator();
        }

        function checkForSharedContent() {
          const hash = window.location.hash;
          if (hash.startsWith("#s=")) {
            const compressed = hash.substring(3); // Remove '#s='
            const payload = decompressContent(compressed);

            if (payload && payload.content) {
              enterSharedViewMode(payload.content, payload.ts);
              return true;
            } else {
              // Invalid or corrupted data
              showToast(
                "Failed to load shared content. The link may be corrupted or invalid."
              );
              history.replaceState(null, "", window.location.pathname);
            }
          }
          return false;
        }

        // ========================================
        // AUTO SAVE TO AVAILABLE SLOT
        // ========================================
        function saveToAvailableSlot() {
          const contentToSave = sharedContent || markdownEditor.value;

          // Find an available slot (empty document or add new document)
          let targetDocId = null;

          // First, try to find an empty document among visible ones
          for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
            if (visibleDocuments.includes(i)) {
              const doc = loadDocument(i);
              if (!doc.content.trim()) {
                targetDocId = i;
                break;
              }
            }
          }

          // If no empty document found, try to add a new document
          if (!targetDocId && visibleDocuments.length < CONFIG.MAX_DOCUMENTS) {
            for (let i = 2; i <= CONFIG.MAX_DOCUMENTS; i++) {
              if (!visibleDocuments.includes(i)) {
                showDocument(i);
                targetDocId = i;
                break;
              }
            }
          }

          const isCollapsed = documentsBar.classList.contains("collapsed");
          if (isCollapsed) {
            toggleDocumentsPanel();
          }

          // If still no slot available, warn user
          if (!targetDocId) {
            showToast(
              `All ${CONFIG.MAX_DOCUMENTS} document slots are occupied. Please remove or clear a document first.`
            );
            return;
          }

          // Save to the target slot
          saveDocument(targetDocId, contentToSave);

          // Switch to that document and exit shared view
          if (isSharedViewMode) {
            exitSharedViewMode();
          }
          switchToDocument(targetDocId);

          // Show success feedback
          showToast(`Content saved to Document ${targetDocId}`);

          // Ensure header indicators are updated after saving
          updateCurrentDocIndicator();
        }

        // ========================================
        // DOCUMENT SYSTEM INITIALIZATION
        // ========================================
        function initializeDocumentSystem() {
          // Load saved visible documents
          const savedVisibleDocs = localStorage.getItem(
            STORAGE_KEYS.VISIBLE_DOCS
          );
          if (savedVisibleDocs) {
            try {
              visibleDocuments = JSON.parse(savedVisibleDocs);
            } catch (e) {
              visibleDocuments = [1];
            }
          } else {
            visibleDocuments = [1];
          }

          // Ensure Document 1 is always visible
          if (!visibleDocuments.includes(1)) {
            visibleDocuments.unshift(1);
          }

          // Load saved current document ID
          const savedDocId = localStorage.getItem(STORAGE_KEYS.CURRENT_DOC_ID);
          if (savedDocId && visibleDocuments.includes(parseInt(savedDocId))) {
            currentDocumentId = parseInt(savedDocId);
          } else {
            currentDocumentId = 1;
          }

          // Load the current document (skip if in shared view mode)
          if (!isSharedViewMode) {
            const docData = loadDocument(currentDocumentId);
            markdownEditor.value = docData.content;
          }

          // Load collapsed state (default to collapsed)
          const docsCollapsed = localStorage.getItem(
            STORAGE_KEYS.DOCS_COLLAPSED
          );
          if (docsCollapsed === null || docsCollapsed === "true") {
            documentsBar.classList.add("collapsed");
            btnToggleDocsHeader.classList.remove("active");
          } else {
            btnToggleDocsHeader.classList.add("active");
          }

          // Show/hide documents based on visibility state
          for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
            const docCard = document.querySelector(`[data-doc="${i}"]`);
            if (visibleDocuments.includes(i)) {
              docCard.style.display = "block";
            } else {
              docCard.style.display = "none";
            }
          }

          // Update all document displays
          for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
            updateDocumentDisplay(i);
          }

          // Update current doc indicator
          updateCurrentDocIndicator();

          // Position the add button
          positionAddButton();

          // Attach event listeners to document cards
          document.querySelectorAll(".doc-card[data-doc]").forEach((card) => {
            const docId = parseInt(card.getAttribute("data-doc"));

            // Click on card to switch document (except when clicking buttons)
            card.addEventListener("click", (e) => {
              if (!e.target.closest(".doc-actions")) {
                switchToDocument(docId);
              }
            });

            // Delete button (now removes the document)
            card.querySelector(".delete-btn").addEventListener("click", (e) => {
              e.stopPropagation();
              removeDocument(docId);
            });
          });
        }

        // ========================================
        // TIME & WORD COUNT UPDATES
        // ========================================
        function updateTime() {
          const now = new Date();
          currentTime.textContent = now.toLocaleTimeString();
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        // Debounce timeout for URL updates and autosave
        let debounceTimeout = null;

        markdownEditor.addEventListener("input", function () {
          renderMarkdown();

          // Debounced operations (URL updates for shared mode or autosave for normal mode)
          clearTimeout(debounceTimeout);

          // Update the sharedContent variable so saves get the latest content
          if (isSharedViewMode) {
            sharedContent = markdownEditor.value;
          }

          // Single timeout that handles both URL updates and autosave
          debounceTimeout = setTimeout(() => {
            if (isSharedViewMode) {
              // Update URL in shared mode
              const content = markdownEditor.value;
              if (content.trim()) {
                const compressed = compressContent(content);
                const newUrl = `${
                  window.location.href.split("#")[0]
                }#s=${compressed}`;
                history.replaceState(null, "", newUrl);
              }
            } else if (isAutosaveEnabled(currentDocumentId)) {
              // Autosave in normal mode
              saveDocument(currentDocumentId, markdownEditor.value);
              // Flash check icon in autosave status header
              flashButtonCheck(autosaveStatusHeader);
            }
          }, CONFIG.AUTOSAVE_DEBOUNCE_DELAY);
        });

        // Ctrl+S save functionality
        markdownEditor.addEventListener("keydown", function (e) {
          if ((e.ctrlKey || e.metaKey) && e.key === "s") {
            e.preventDefault(); // Prevent browser save dialog

            // In shared view mode, save to available slot
            if (isSharedViewMode) {
              if (markdownEditor.value.trim()) {
                saveToAvailableSlot();
              }
              return;
            }

            // Trigger save action for normal documents
            if (markdownEditor.value.trim()) {
              saveDocument(currentDocumentId, markdownEditor.value);
              if (isAutosaveEnabled(currentDocumentId)) {
                flashButtonCheck(autosaveStatusHeader);
              }

              // Brief visual feedback in the manual save button
              const manualSaveBtn =
                document.getElementById("manual-save-split");
              const original = manualSaveBtn.innerHTML;
              manualSaveBtn.innerHTML = `<span class="icon-svg"><svg><use href="${ICONS.CHECK}"/></svg></span>`;
              setTimeout(() => {
                manualSaveBtn.innerHTML = original;
              }, CONFIG.SAVE_FEEDBACK_DURATION);
            }
          }
        });

        // Function to toggle syntax highlighting theme
        function toggleHighlightTheme(isDark) {
          const lightTheme = document.getElementById("highlight-light");
          const darkTheme = document.getElementById("highlight-dark");

          if (isDark) {
            lightTheme.disabled = true;
            darkTheme.disabled = false;
          } else {
            lightTheme.disabled = false;
            darkTheme.disabled = true;
          }
        }

        // ========================================
        // THEME MANAGEMENT
        // ========================================
        let isThemeAnimationInProgress = false;

        btnThemeToggle.addEventListener("click", function () {
          if (isThemeAnimationInProgress) {
            return;
          }

          document.body.classList.toggle("theme-dark");

          // Save theme preference
          const isDark = document.body.classList.contains("theme-dark");
          localStorage.setItem(STORAGE_KEYS.THEME, isDark);

          // Update theme toggle icon with animation
          isThemeAnimationInProgress = true;
          updateThemeToggleIcon(isDark, true);

          // Toggle syntax highlighting theme
          toggleHighlightTheme(isDark);

          // Re-render to apply new syntax highlighting
          renderMarkdown();
        });

        function updateThemeToggleIcon(isDark, animated = false) {
          const icon = isDark ? ICONS.MOON : ICONS.SUN;

          if (!animated) {
            // Initial load without animation
            btnThemeToggle.innerHTML = `<span class="icon-svg"><svg><use href="${icon}"/></svg></span>`;
          } else {
            // Animated transition
            const currentIcon = btnThemeToggle.querySelector(".icon-svg");

            // Add exiting animation to current icon
            currentIcon.classList.add("exiting");

            // Create new icon with entering animation
            const newIconWrapper = document.createElement("span");
            newIconWrapper.className = "icon-svg entering";
            newIconWrapper.innerHTML = `<svg><use href="${icon}"/></svg>`;
            newIconWrapper.style.position = "absolute";

            btnThemeToggle.appendChild(newIconWrapper);

            // Remove old icon after animation completes
            setTimeout(() => {
              if (currentIcon.parentNode === btnThemeToggle) {
                btnThemeToggle.removeChild(currentIcon);
              }
              newIconWrapper.style.position = "static";
              newIconWrapper.classList.remove("entering");

              isThemeAnimationInProgress = false;
            }, CONFIG.ICON_ANIMATION_DURATION);
          }
        }

        // ========================================
        // CLIPBOARD OPERATIONS (Modern API)
        // ========================================
        async function copyToClipboard(text) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (err) {
            // Fallback for older browsers
            const tempElement = document.createElement("textarea");
            tempElement.value = text;
            tempElement.style.position = "fixed";
            tempElement.style.opacity = "0";
            document.body.appendChild(tempElement);
            tempElement.select();
            try {
              document.execCommand("copy");
              return true;
            } catch (e) {
              console.error("Failed to copy to clipboard");
              return false;
            }
            document.body.removeChild(tempElement);
          }
        }

        btnCopyMarkdown.addEventListener("click", function () {
          copyToClipboard(markdownEditor.value).then((ok) => {
            if (ok) flashButtonCheck(btnCopyMarkdown);
          });
        });

        async function saveMarkdownViaPicker(content) {
          if (!("showSaveFilePicker" in window)) return false;
          try {
            const opts = {
              suggestedName: `Document_${currentDocumentId}.md`,
              types: [
                {
                  description: "Markdown File",
                  accept: { "text/markdown": [".md"] },
                },
              ],
            };
            const handle = await window.showSaveFilePicker(opts);
            const writable = await handle.createWritable();
            await writable.write(
              new Blob([content], { type: "text/markdown;charset=utf-8" })
            );
            await writable.close();
            return true;
          } catch (e) {
            // User canceled or API failed; fall back
            return false;
          }
        }

        if (btnSaveMarkdown) {
          btnSaveMarkdown.addEventListener("click", async function () {
            const content = markdownEditor.value;
            if (!content.trim()) {
              showToast("Nothing to save. The document is empty.");
              return;
            }
            await saveMarkdownViaPicker(content);
          });
        }

        btnExportPdf.addEventListener("click", function () {
          // Store current theme state
          const wasDarkMode = document.body.classList.contains("theme-dark");

          // Temporarily switch to light mode for better printing
          if (wasDarkMode) {
            document.body.classList.remove("theme-dark");
            // Update syntax highlighting theme
            toggleHighlightTheme(false);
          }

          // Trigger browser's print dialog for PDF export
          window.print();

          // Restore original theme after a short delay
          setTimeout(() => {
            if (wasDarkMode) {
              document.body.classList.add("theme-dark");
              // Restore syntax highlighting theme
              toggleHighlightTheme(true);
            }
          }, 300);
        });

        // Documents panel toggle
        btnToggleDocsHeader.addEventListener("click", function () {
          toggleDocumentsPanel();
        });

        // Header autosave toggle - toggles between auto and manual
        autosaveToggleHeader.addEventListener("click", function () {
          const currentState = isAutosaveEnabled(currentDocumentId);
          const newState = !currentState;
          setAutosaveEnabled(currentDocumentId, newState);
          updateDocumentDisplay(currentDocumentId);

          // Show toast notification for autosave state change
          const stateText = newState ? "enabled" : "disabled";
          showToast(`Autosave ${stateText}.`);
        });

        // Manual save split button - saves the document
        manualSaveSplit.addEventListener("click", function () {
          if (markdownEditor.value.trim()) {
            saveDocument(currentDocumentId, markdownEditor.value);

            // Brief visual feedback
            const btn = this;
            const original = btn.innerHTML;
            btn.innerHTML = `<span class="icon-svg"><svg><use href="${ICONS.CHECK}"/></svg></span>`;
            setTimeout(() => {
              btn.innerHTML = original;
            }, CONFIG.SAVE_FEEDBACK_DURATION);
          }
        });

        // Share button - generates and copies share link
        const btnShare = document.getElementById("btn-share");
        const shareAction = document.querySelector(".share-action");
        const shareTooltip = document.getElementById("share-tooltip");
        const shareLinkPreview = document.getElementById("share-link-preview");
        const shareCopyBtn = document.getElementById("share-copy-btn");
        const shareNativeBtn = document.getElementById("share-native-btn");
        let currentShareUrl = "";
        let shareTooltipVisible = false;

        if (shareNativeBtn && !("share" in navigator)) {
          shareNativeBtn.classList.add("is-hidden");
        }

        function formatSharePreview(url) {
          const maxLength = 120;
          if (url.length <= maxLength) {
            return url;
          }
          return `${url.slice(0, 44)}...${url.slice(-12)}`;
        }

        function openShareTooltip(url) {
          if (!shareTooltip || !shareLinkPreview) return;

          currentShareUrl = url;
          shareLinkPreview.textContent = formatSharePreview(url);
          shareLinkPreview.title = url;

          // Show/hide warning based on URL length
          const warningEl = document.getElementById("share-tooltip-warning");
          const warningTextEl = warningEl?.querySelector(
            ".share-tooltip-warning-text"
          );

          if (url.length > 1800 && warningEl && warningTextEl) {
            warningTextEl.textContent = `This document and the share-link is long which may not work in all browsers.`;
            warningEl.style.display = "block";
          } else if (warningEl) {
            warningEl.style.display = "none";
          }

          if (shareNativeBtn) {
            if ("share" in navigator) {
              shareNativeBtn.classList.remove("is-hidden");
            } else {
              shareNativeBtn.classList.add("is-hidden");
            }
          }

          shareTooltip.classList.add("is-visible");
          shareTooltip.setAttribute("aria-hidden", "false");
          shareTooltipVisible = true;
          if (shareCopyBtn) {
            shareCopyBtn.focus();
          }
        }

        function closeShareTooltip() {
          if (!shareTooltipVisible || !shareTooltip) return;
          shareTooltip.classList.remove("is-visible");
          shareTooltip.setAttribute("aria-hidden", "true");
          shareTooltipVisible = false;
        }

        if (shareTooltip) {
          shareTooltip.addEventListener("click", function (event) {
            event.stopPropagation();
          });
        }

        if (btnShare) {
          btnShare.addEventListener("click", function (event) {
            event.stopPropagation();

            // If tooltip is already visible, just close it
            if (shareTooltipVisible) {
              closeShareTooltip();
              return;
            }

            // Otherwise, generate share link and open tooltip
            const result = generateShareLink();
            if (!result) return;

            const { url } = result;
            openShareTooltip(url);
          });
        }

        if (shareCopyBtn) {
          shareCopyBtn.addEventListener("click", async function (event) {
            event.stopPropagation();
            if (!currentShareUrl) return;
            const ok = await copyToClipboard(currentShareUrl);
            if (ok) flashButtonCheck(shareCopyBtn);
          });
        }

        if (shareNativeBtn) {
          shareNativeBtn.addEventListener("click", async function (event) {
            event.stopPropagation();
            if (!currentShareUrl || !("share" in navigator)) {
              return;
            }

            try {
              await navigator.share({
                title: "Markdown Previewer",
                text: "",
                url: currentShareUrl,
              });
            } catch (err) {
              if (!(err && err.name === "AbortError")) {
                showToast(
                  "Sharing was not completed. You can copy the link instead."
                );
              }
            }
          });
        }

        document.addEventListener("click", function (event) {
          if (
            shareTooltipVisible &&
            shareAction &&
            !shareAction.contains(event.target)
          ) {
            closeShareTooltip();
          }
        });

        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            closeShareTooltip();
          }
        });

        // Banner save button
        const btnSaveFromBanner = document.getElementById(
          "btn-save-from-banner"
        );
        btnSaveFromBanner.addEventListener("click", function () {
          saveToAvailableSlot();
        });

        // ========================================
        // INITIALIZATION
        // ========================================
        // Initial render and update time
        updateTime();

        // Update time every second
        setInterval(updateTime, 1000);

        // Update relative times every minute
        setInterval(updateAllDocumentTimes, 60000);

        // Theme is already applied by inline script, just check current state for other logic
        const isDark = document.body.classList.contains("theme-dark");

        // Apply the correct syntax highlighting theme on load
        toggleHighlightTheme(isDark);

        // Initialize theme toggle icon
        updateThemeToggleIcon(isDark);

        // Initialize panel sizes and resizer
        initPanelSizes();
        setupResizer();

        // Check for shared content BEFORE initializing documents
        const hasSharedContent = checkForSharedContent();

        // Always initialize document system to show existing docs
        initializeDocumentSystem();

        // If we loaded shared content, make sure the UI reflects shared mode
        if (hasSharedContent) {
          renderMarkdown();
        }

        // ========================================
        // CROSS-TAB SYNC (storage event)
        // ========================================
        function handleStorageChange(event) {
          if (!event || event.storageArea !== localStorage) return;

          const key = event.key;
          const newValue = event.newValue;
          if (!key) return;

          // Theme changes
          if (key === STORAGE_KEYS.THEME) {
            const isDarkNow = newValue === "true";
            document.body.classList.toggle("theme-dark", isDarkNow);
            toggleHighlightTheme(isDarkNow);
            updateThemeToggleIcon(isDarkNow);
            renderMarkdown();
            return;
          }

          // Panel sizes
          if (
            key === STORAGE_KEYS.EDITOR_WIDTH ||
            key === STORAGE_KEYS.PREVIEW_WIDTH
          ) {
            const editorPanel = document.getElementById("editor-panel");
            const previewPanel = document.getElementById("preview-panel");
            const savedEditorWidth = localStorage.getItem(
              STORAGE_KEYS.EDITOR_WIDTH
            );
            const savedPreviewWidth = localStorage.getItem(
              STORAGE_KEYS.PREVIEW_WIDTH
            );
            if (savedEditorWidth) editorPanel.style.flex = savedEditorWidth;
            if (savedPreviewWidth) previewPanel.style.flex = savedPreviewWidth;
            return;
          }

          // Visible documents set
          if (key === STORAGE_KEYS.VISIBLE_DOCS) {
            try {
              const parsed = JSON.parse(newValue || "[]");
              if (Array.isArray(parsed)) {
                visibleDocuments = parsed.includes(1) ? parsed : [1, ...parsed];
                // Apply visibility to cards
                for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
                  const card = document.querySelector(`[data-doc="${i}"]`);
                  if (!card) continue;
                  if (visibleDocuments.includes(i)) {
                    card.style.display = "block";
                  } else if (i !== 1) {
                    card.style.display = "none";
                  }
                }
                // Update delete button states and previews
                for (let i = 1; i <= CONFIG.MAX_DOCUMENTS; i++) {
                  updateDocumentDisplay(i);
                }
                // Reposition add button
                positionAddButton();
              }
            } catch (e) {}
            return;
          }

          // Autosave flag per document
          const autosaveMatch = key.match(/^markdownDoc(\d+)_autosave$/);
          if (autosaveMatch) {
            const docId = parseInt(autosaveMatch[1], 10);
            if (docId === currentDocumentId) {
              updateCurrentDocIndicator();
              updateDocumentDisplay(docId);
            }
            return;
          }

          // Document content updates (markdownDocN)
          const docMatch = key.match(/^markdownDoc(\d+)$/);
          if (docMatch) {
            const docId = parseInt(docMatch[1], 10);
            // Update card preview/time
            updateDocumentDisplay(docId);

            return;
          }
        }

        window.addEventListener("storage", handleStorageChange);

        // Listen for navigation events to handle back/forward button for shared URLs
        window.addEventListener("popstate", function (event) {
          const hash = window.location.hash;
          if (hash.startsWith("#s=")) {
            // User navigated back to a shared URL
            const compressed = hash.substring(3);
            const payload = decompressContent(compressed);

            if (payload && payload.content) {
              // Enter shared view mode
              enterSharedViewMode(payload.content, payload.ts);
            }
          } else if (isSharedViewMode && !event.state?.sharedView) {
            // User navigated away from shared URL while in shared view mode
            exitSharedViewMode();
          }
        });

        // Initial render
        renderMarkdown();
      });
    </script>
  </body>
</html>
